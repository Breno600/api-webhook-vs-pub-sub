Exec using JSCH
Connecting to 10.218.238.144 ....
Connection to 10.218.238.144 established
Executing command ...
export GIT_TAG=DEV000000008
Clonando repo em /tmp/tmp.Cv5NSOF379...
Cloning into '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef'...
remote: Enumerating objects: 612, done.
remote: Counting objects:   0% (1/562)
remote: Counting objects:   1% (6/562)
remote: Counting objects:   2% (12/562)
remote: Counting objects:   3% (17/562)
remote: Counting objects:   4% (23/562)
remote: Counting objects:   5% (29/562)
remote: Counting objects:   6% (34/562)
remote: Counting objects:   7% (40/562)
remote: Counting objects:   8% (45/562)
remote: Counting objects:   9% (51/562)
remote: Counting objects:  10% (57/562)
remote: Counting objects:  11% (62/562)
remote: Counting objects:  12% (68/562)
remote: Counting objects:  13% (74/562)
remote: Counting objects:  14% (79/562)
remote: Counting objects:  15% (85/562)
remote: Counting objects:  16% (90/562)
remote: Counting objects:  17% (96/562)
remote: Counting objects:  18% (102/562)
remote: Counting objects:  19% (107/562)
remote: Counting objects:  20% (113/562)
remote: Counting objects:  21% (119/562)
remote: Counting objects:  22% (124/562)
remote: Counting objects:  23% (130/562)
remote: Counting objects:  24% (135/562)
remote: Counting objects:  25% (141/562)
remote: Counting objects:  26% (147/562)
remote: Counting objects:  27% (152/562)
remote: Counting objects:  28% (158/562)
remote: Counting objects:  29% (163/562)
remote: Counting objects:  30% (169/562)
remote: Counting objects:  31% (175/562)
remote: Counting objects:  32% (180/562)
remote: Counting objects:  33% (186/562)
remote: Counting objects:  34% (192/562)
remote: Counting objects:  35% (197/562)
remote: Counting objects:  36% (203/562)
remote: Counting objects:  37% (208/562)
remote: Counting objects:  38% (214/562)
remote: Counting objects:  39% (220/562)
remote: Counting objects:  40% (225/562)
remote: Counting objects:  41% (231/562)
remote: Counting objects:  42% (237/562)
remote: Counting objects:  43% (242/562)
remote: Counting objects:  44% (248/562)
remote: Counting objects:  45% (253/562)
remote: Counting objects:  46% (259/562)
remote: Counting objects:  47% (265/562)
remote: Counting objects:  48% (270/562)
remote: Counting objects:  49% (276/562)
remote: Counting objects:  50% (281/562)
remote: Counting objects:  51% (287/562)
remote: Counting objects:  52% (293/562)
remote: Counting objects:  53% (298/562)
remote: Counting objects:  54% (304/562)
remote: Counting objects:  55% (310/562)
remote: Counting objects:  56% (315/562)
remote: Counting objects:  57% (321/562)
remote: Counting objects:  58% (326/562)
remote: Counting objects:  59% (332/562)
remote: Counting objects:  60% (338/562)
remote: Counting objects:  61% (343/562)
remote: Counting objects:  62% (349/562)
remote: Counting objects:  63% (355/562)
remote: Counting objects:  64% (360/562)
remote: Counting objects:  65% (366/562)
remote: Counting objects:  66% (371/562)
remote: Counting objects:  67% (377/562)
remote: Counting objects:  68% (383/562)
remote: Counting objects:  69% (388/562)
remote: Counting objects:  70% (394/562)
remote: Counting objects:  71% (400/562)
remote: Counting objects:  72% (405/562)
remote: Counting objects:  73% (411/562)
remote: Counting objects:  74% (416/562)
remote: Counting objects:  75% (422/562)
remote: Counting objects:  76% (428/562)
remote: Counting objects:  77% (433/562)
remote: Counting objects:  78% (439/562)
remote: Counting objects:  79% (444/562)
remote: Counting objects:  80% (450/562)
remote: Counting objects:  81% (456/562)
remote: Counting objects:  82% (461/562)
remote: Counting objects:  83% (467/562)
remote: Counting objects:  84% (473/562)
remote: Counting objects:  85% (478/562)
remote: Counting objects:  86% (484/562)
remote: Counting objects:  87% (489/562)
remote: Counting objects:  88% (495/562)
remote: Counting objects:  89% (501/562)
remote: Counting objects:  90% (506/562)
remote: Counting objects:  91% (512/562)
remote: Counting objects:  92% (518/562)
remote: Counting objects:  93% (523/562)
remote: Counting objects:  94% (529/562)
remote: Counting objects:  95% (534/562)
remote: Counting objects:  96% (540/562)
remote: Counting objects:  97% (546/562)
remote: Counting objects:  98% (551/562)
remote: Counting objects:  99% (557/562)
remote: Counting objects: 100% (562/562)
remote: Counting objects: 100% (562/562), done.
remote: Compressing objects:   0% (1/549)
remote: Compressing objects:   1% (6/549)
remote: Compressing objects:   2% (11/549)
remote: Compressing objects:   3% (17/549)
remote: Compressing objects:   4% (22/549)
remote: Compressing objects:   5% (28/549)
remote: Compressing objects:   6% (33/549)
remote: Compressing objects:   7% (39/549)
remote: Compressing objects:   8% (44/549)
remote: Compressing objects:   9% (50/549)
remote: Compressing objects:  10% (55/549)
remote: Compressing objects:  11% (61/549)
remote: Compressing objects:  12% (66/549)
remote: Compressing objects:  13% (72/549)
remote: Compressing objects:  14% (77/549)
remote: Compressing objects:  15% (83/549)
remote: Compressing objects:  16% (88/549)
remote: Compressing objects:  17% (94/549)
remote: Compressing objects:  18% (99/549)
remote: Compressing objects:  19% (105/549)
remote: Compressing objects:  20% (110/549)
remote: Compressing objects:  21% (116/549)
remote: Compressing objects:  22% (121/549)
remote: Compressing objects:  23% (127/549)
remote: Compressing objects:  24% (132/549)
remote: Compressing objects:  25% (138/549)
remote: Compressing objects:  26% (143/549)
remote: Compressing objects:  27% (149/549)
remote: Compressing objects:  28% (154/549)
remote: Compressing objects:  29% (160/549)
remote: Compressing objects:  30% (165/549)
remote: Compressing objects:  31% (171/549)
remote: Compressing objects:  32% (176/549)
remote: Compressing objects:  33% (182/549)
remote: Compressing objects:  34% (187/549)
remote: Compressing objects:  35% (193/549)
remote: Compressing objects:  36% (198/549)
remote: Compressing objects:  37% (204/549)
remote: Compressing objects:  38% (209/549)
remote: Compressing objects:  39% (215/549)
remote: Compressing objects:  40% (220/549)
remote: Compressing objects:  41% (226/549)
remote: Compressing objects:  42% (231/549)
remote: Compressing objects:  43% (237/549)
remote: Compressing objects:  44% (242/549)
remote: Compressing objects:  45% (248/549)
remote: Compressing objects:  46% (253/549)
remote: Compressing objects:  47% (259/549)
remote: Compressing objects:  48% (264/549)
remote: Compressing objects:  49% (270/549)
remote: Compressing objects:  50% (275/549)
remote: Compressing objects:  51% (280/549)
remote: Compressing objects:  52% (286/549)
remote: Compressing objects:  53% (291/549)
remote: Compressing objects:  54% (297/549)
remote: Compressing objects:  55% (302/549)
remote: Compressing objects:  56% (308/549)
remote: Compressing objects:  57% (313/549)
remote: Compressing objects:  58% (319/549)
remote: Compressing objects:  59% (324/549)
remote: Compressing objects:  60% (330/549)
remote: Compressing objects:  61% (335/549)
remote: Compressing objects:  62% (341/549)
remote: Compressing objects:  63% (346/549)
remote: Compressing objects:  64% (352/549)
remote: Compressing objects:  65% (357/549)
remote: Compressing objects:  66% (363/549)
remote: Compressing objects:  67% (368/549)
remote: Compressing objects:  68% (374/549)
remote: Compressing objects:  69% (379/549)
remote: Compressing objects:  70% (385/549)
remote: Compressing objects:  71% (390/549)
remote: Compressing objects:  72% (396/549)
remote: Compressing objects:  73% (401/549)
remote: Compressing objects:  74% (407/549)
remote: Compressing objects:  75% (412/549)
remote: Compressing objects:  76% (418/549)
remote: Compressing objects:  77% (423/549)
remote: Compressing objects:  78% (429/549)
remote: Compressing objects:  79% (434/549)
remote: Compressing objects:  80% (440/549)
remote: Compressing objects:  81% (445/549)
remote: Compressing objects:  82% (451/549)
remote: Compressing objects:  83% (456/549)
remote: Compressing objects:  84% (462/549)
remote: Compressing objects:  85% (467/549)
remote: Compressing objects:  86% (473/549)
remote: Compressing objects:  87% (478/549)
remote: Compressing objects:  88% (484/549)
remote: Compressing objects:  89% (489/549)
remote: Compressing objects:  90% (495/549)
remote: Compressing objects:  91% (500/549)
remote: Compressing objects:  92% (506/549)
remote: Compressing objects:  93% (511/549)
remote: Compressing objects:  94% (517/549)
remote: Compressing objects:  95% (522/549)
remote: Compressing objects:  96% (528/549)
remote: Compressing objects:  97% (533/549)
remote: Compressing objects:  98% (539/549)
remote: Compressing objects:  99% (544/549)
remote: Compressing objects: 100% (549/549)
remote: Compressing objects: 100% (549/549), done.
remote: Total 612 (delta 349), reused 0 (delta 0), pack-reused 50
Receiving objects:   0% (1/612)
Receiving objects:   1% (7/612)
Receiving objects:   2% (13/612)
Receiving objects:   3% (19/612)
Receiving objects:   4% (25/612)
Receiving objects:   5% (31/612)
Receiving objects:   6% (37/612)
Receiving objects:   7% (43/612)
Receiving objects:   8% (49/612)
Receiving objects:   9% (56/612)
Receiving objects:  10% (62/612)
Receiving objects:  11% (68/612)
Receiving objects:  12% (74/612)
Receiving objects:  13% (80/612)
Receiving objects:  14% (86/612)
Receiving objects:  15% (92/612)
Receiving objects:  16% (98/612)
Receiving objects:  17% (105/612)
Receiving objects:  18% (111/612)
Receiving objects:  19% (117/612)
Receiving objects:  20% (123/612)
Receiving objects:  21% (129/612)
Receiving objects:  22% (135/612)
Receiving objects:  23% (141/612)
Receiving objects:  24% (147/612)
Receiving objects:  25% (153/612)
Receiving objects:  26% (160/612)
Receiving objects:  27% (166/612)
Receiving objects:  28% (172/612)
Receiving objects:  29% (178/612)
Receiving objects:  30% (184/612)
Receiving objects:  31% (190/612)
Receiving objects:  32% (196/612)
Receiving objects:  33% (202/612)
Receiving objects:  34% (209/612)
Receiving objects:  35% (215/612)
Receiving objects:  36% (221/612)
Receiving objects:  37% (227/612)
Receiving objects:  38% (233/612)
Receiving objects:  39% (239/612)
Receiving objects:  40% (245/612)
Receiving objects:  41% (251/612)
Receiving objects:  42% (258/612)
Receiving objects:  43% (264/612)
Receiving objects:  44% (270/612)
Receiving objects:  45% (276/612)
Receiving objects:  46% (282/612)
Receiving objects:  47% (288/612)
Receiving objects:  48% (294/612)
Receiving objects:  49% (300/612)
Receiving objects:  50% (306/612)
Receiving objects:  51% (313/612)
Receiving objects:  52% (319/612)
Receiving objects:  53% (325/612)
Receiving objects:  54% (331/612)
Receiving objects:  55% (337/612)
Receiving objects:  56% (343/612)
Receiving objects:  57% (349/612)
Receiving objects:  58% (355/612)
Receiving objects:  59% (362/612)
Receiving objects:  60% (368/612)
Receiving objects:  61% (374/612)
Receiving objects:  62% (380/612)
Receiving objects:  63% (386/612)
Receiving objects:  64% (392/612)
Receiving objects:  65% (398/612)
Receiving objects:  66% (404/612)
Receiving objects:  67% (411/612)
Receiving objects:  68% (417/612)
Receiving objects:  69% (423/612)
Receiving objects:  70% (429/612)
Receiving objects:  71% (435/612)
Receiving objects:  72% (441/612)
Receiving objects:  73% (447/612)
Receiving objects:  74% (453/612)
Receiving objects:  75% (459/612)
Receiving objects:  76% (466/612)
Receiving objects:  77% (472/612)
Receiving objects:  78% (478/612)
Receiving objects:  79% (484/612)
Receiving objects:  80% (490/612)
Receiving objects:  81% (496/612)
Receiving objects:  82% (502/612)
Receiving objects:  83% (508/612)
Receiving objects:  84% (515/612)
Receiving objects:  85% (521/612)
Receiving objects:  86% (527/612)
Receiving objects:  87% (533/612)
Receiving objects:  88% (539/612)
Receiving objects:  89% (545/612)
Receiving objects:  90% (551/612)
Receiving objects:  91% (557/612)
Receiving objects:  92% (564/612)
Receiving objects:  93% (570/612)
Receiving objects:  94% (576/612)
Receiving objects:  95% (582/612)
Receiving objects:  96% (588/612)
Receiving objects:  97% (594/612)
Receiving objects:  98% (600/612)
Receiving objects:  99% (606/612)
Receiving objects: 100% (612/612)
Receiving objects: 100% (612/612), 103.95 KiB | 812.00 KiB/s, done.
Resolving deltas:   0% (0/368)
Resolving deltas:   1% (4/368)
Resolving deltas:   2% (8/368)
Resolving deltas:   3% (12/368)
Resolving deltas:   4% (15/368)
Resolving deltas:   5% (19/368)
Resolving deltas:   6% (23/368)
Resolving deltas:   7% (26/368)
Resolving deltas:   8% (30/368)
Resolving deltas:   9% (34/368)
Resolving deltas:  10% (37/368)
Resolving deltas:  11% (41/368)
Resolving deltas:  12% (45/368)
Resolving deltas:  13% (48/368)
Resolving deltas:  14% (52/368)
Resolving deltas:  15% (56/368)
Resolving deltas:  16% (59/368)
Resolving deltas:  17% (63/368)
Resolving deltas:  18% (67/368)
Resolving deltas:  19% (70/368)
Resolving deltas:  20% (74/368)
Resolving deltas:  21% (78/368)
Resolving deltas:  22% (81/368)
Resolving deltas:  23% (85/368)
Resolving deltas:  24% (89/368)
Resolving deltas:  25% (92/368)
Resolving deltas:  26% (96/368)
Resolving deltas:  27% (100/368)
Resolving deltas:  28% (104/368)
Resolving deltas:  29% (107/368)
Resolving deltas:  30% (111/368)
Resolving deltas:  31% (115/368)
Resolving deltas:  32% (118/368)
Resolving deltas:  33% (122/368)
Resolving deltas:  34% (127/368)
Resolving deltas:  35% (129/368)
Resolving deltas:  36% (133/368)
Resolving deltas:  37% (137/368)
Resolving deltas:  38% (140/368)
Resolving deltas:  39% (144/368)
Resolving deltas:  40% (148/368)
Resolving deltas:  41% (151/368)
Resolving deltas:  42% (155/368)
Resolving deltas:  43% (159/368)
Resolving deltas:  44% (162/368)
Resolving deltas:  45% (166/368)
Resolving deltas:  46% (170/368)
Resolving deltas:  47% (173/368)
Resolving deltas:  48% (177/368)
Resolving deltas:  49% (181/368)
Resolving deltas:  50% (184/368)
Resolving deltas:  51% (188/368)
Resolving deltas:  52% (192/368)
Resolving deltas:  53% (196/368)
Resolving deltas:  54% (199/368)
Resolving deltas:  55% (203/368)
Resolving deltas:  56% (207/368)
Resolving deltas:  57% (210/368)
Resolving deltas:  58% (214/368)
Resolving deltas:  59% (218/368)
Resolving deltas:  60% (221/368)
Resolving deltas:  61% (225/368)
Resolving deltas:  62% (229/368)
Resolving deltas:  63% (232/368)
Resolving deltas:  64% (236/368)
Resolving deltas:  65% (240/368)
Resolving deltas:  66% (243/368)
Resolving deltas:  67% (247/368)
Resolving deltas:  68% (251/368)
Resolving deltas:  69% (254/368)
Resolving deltas:  70% (258/368)
Resolving deltas:  71% (262/368)
Resolving deltas:  72% (265/368)
Resolving deltas:  73% (269/368)
Resolving deltas:  74% (273/368)
Resolving deltas:  75% (276/368)
Resolving deltas:  76% (280/368)
Resolving deltas:  77% (284/368)
Resolving deltas:  78% (288/368)
Resolving deltas:  79% (291/368)
Resolving deltas:  80% (295/368)
Resolving deltas:  81% (299/368)
Resolving deltas:  82% (302/368)
Resolving deltas:  83% (306/368)
Resolving deltas:  84% (310/368)
Resolving deltas:  85% (313/368)
Resolving deltas:  86% (317/368)
Resolving deltas:  87% (321/368)
Resolving deltas:  88% (324/368)
Resolving deltas:  89% (328/368)
Resolving deltas:  90% (332/368)
Resolving deltas:  91% (335/368)
Resolving deltas:  92% (340/368)
Resolving deltas:  93% (343/368)
Resolving deltas:  94% (346/368)
Resolving deltas:  95% (350/368)
Resolving deltas:  96% (354/368)
Resolving deltas:  97% (357/368)
Resolving deltas:  98% (361/368)
Resolving deltas:  99% (365/368)
Resolving deltas: 100% (368/368)
Resolving deltas: 100% (368/368), done.
== PIPELINE PREDEPLOY ==
TAG   : DEV000000008
EXEC  : execution/machine_list_dev.yml
BRANCH: develop
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/localhost as an inventory source
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_from_status.yml with auto plugin: no root 'plugin' key
found, '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_from_status.yml' is not a valid YAML inventory plugin
config file
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_from_status.yml with yaml plugin: YAML inventory has
invalid structure, it should be a dictionary, got: &lt;class
'ansible.parsing.yaml.objects.AnsibleSequence'>
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_from_status.yml with ini plugin:
/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_from_status.yml:8: Expected key=value host variable
assignment, got: name:
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_from_status.yml as an inventory source
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_per_machine.yml with auto plugin: no root 'plugin' key
found, '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_per_machine.yml' is not a valid YAML inventory plugin
config file
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_per_machine.yml with yaml plugin: YAML inventory has
invalid structure, it should be a dictionary, got: &lt;class
'ansible.parsing.yaml.objects.AnsibleSequence'>
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_per_machine.yml with ini plugin:
/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_per_machine.yml:3: Expected key=value host variable
assignment, got: name:
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/deploy_per_machine.yml as an inventory source
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_from_execution.yml with auto plugin: no root 'plugin'
key found, '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_from_execution.yml' is not a valid YAML inventory
plugin config file
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_from_execution.yml with yaml plugin: YAML inventory has
invalid structure, it should be a dictionary, got: &lt;class
'ansible.parsing.yaml.objects.AnsibleSequence'>
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_from_execution.yml with ini plugin:
/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_from_execution.yml:22: Expected key=value host variable
assignment, got: name:
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_from_execution.yml as an inventory source
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_per_machine.yml with auto plugin: no root 'plugin' key
found, '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_per_machine.yml' is not a valid YAML inventory plugin
config file
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_per_machine.yml with yaml plugin: YAML inventory has
invalid structure, it should be a dictionary, got: &lt;class
'ansible.parsing.yaml.objects.AnsibleSequence'>
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_per_machine.yml with ini plugin: Invalid host pattern
'---' supplied, '---' is normally a sign this is a YAML file.
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/predeploy_per_machine.yml as an inventory source
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_from_status.yml with auto plugin: no root 'plugin' key
found, '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_from_status.yml' is not a valid YAML inventory plugin
config file
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_from_status.yml with yaml plugin: YAML inventory has
invalid structure, it should be a dictionary, got: &lt;class
'ansible.parsing.yaml.objects.AnsibleSequence'>
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_from_status.yml with ini plugin:
/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_from_status.yml:3: Expected key=value host variable
assignment, got: name:
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_from_status.yml as an inventory source
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_per_machine.yml with auto plugin: no root 'plugin' key
found, '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_per_machine.yml' is not a valid YAML inventory plugin
config file
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_per_machine.yml with yaml plugin: YAML inventory has
invalid structure, it should be a dictionary, got: &lt;class
'ansible.parsing.yaml.objects.AnsibleSequence'>
[WARNING]:  * Failed to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_per_machine.yml with ini plugin:
/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_per_machine.yml:3: Expected key=value host variable
assignment, got: name:
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible/rollback_per_machine.yml as an inventory source
[WARNING]: Unable to parse /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-
sitef/ansible as an inventory source
[WARNING]: No inventory was parsed, only implicit localhost is available
[WARNING]: provided hosts list is empty, only localhost is available. Note that
the implicit localhost does not match 'all'
PLAY [Predeploy a partir do arquivo de execução] *******************************
TASK [Gathering Facts] *********************************************************
ok: [localhost]
TASK [Resolver filestore_env e filestore_base_dir sem recursão] ****************
ok: [localhost]
TASK [Mostrar variáveis de entrada e resolvidas] *******************************
ok: [localhost] => {
    "msg": [
        "execution_file_name          = execution/machine_list_dev.yml",
        "deployment_ref               = DEV000000008",
        "repo_root_resolved           = /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/..",
        "status_dir_resolved          = /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../status/DEV000000008",
        "filestore_env_resolved       = dev",
        "filestore_base_dir_resolved  = dev/DEV000000008",
        "nexus_base_url               = https://nexus-ci.onefiserv.net/repository/raw-apm0004548-dev"
    ]
}
TASK [Criar diretório de status da TAG] ****************************************
changed: [localhost]
TASK [Carregar arquivo de execução] ********************************************
ok: [localhost]
TASK [Falhar se não tiver máquinas no arquivo de execução] *********************
skipping: [localhost]
TASK [Executar pré-deploy por máquina] *****************************************
included: /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/predeploy_per_machine.yml for localhost => (item=sitef-01)
TASK [Resolver nome da máquina atual] ******************************************
ok: [localhost]
TASK [Definir paths base do repositório] ***************************************
ok: [localhost]
TASK [Definir execution_dir do repositório] ************************************
ok: [localhost]
TASK [Definir machines_dir e packages_dir do repositório] **********************
ok: [localhost]
TASK [Definir candidatos de arquivo da máquina] ********************************
ok: [localhost]
TASK [Verificar candidatos de arquivo da máquina] ******************************
ok: [localhost] => (item=/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/machines/sitef-01.yml)
ok: [localhost] => (item=/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/sitef-01.yml)
ok: [localhost] => (item=/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../machines/sitef-01.yml)
ok: [localhost] => (item=/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../inventory/machines/sitef-01.yml)
TASK [Selecionar machine_file existente] ***************************************
skipping: [localhost] => (item={'changed': False, 'stat': {'exists': False}, 'invocation': {'module_args': {'path': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/machines/sitef-01.yml', 'follow': False, 'get_md5': False, 'get_checksum': True, 'get_mime': True, 'get_attributes': True, 'checksum_algorithm': 'sha1'}}, 'failed': False, 'item': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/machines/sitef-01.yml', 'ansible_loop_var': 'item'}) 
skipping: [localhost] => (item={'changed': False, 'stat': {'exists': False}, 'invocation': {'module_args': {'path': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/sitef-01.yml', 'follow': False, 'get_md5': False, 'get_checksum': True, 'get_mime': True, 'get_attributes': True, 'checksum_algorithm': 'sha1'}}, 'failed': False, 'item': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/sitef-01.yml', 'ansible_loop_var': 'item'}) 
skipping: [localhost] => (item={'changed': False, 'stat': {'exists': False}, 'invocation': {'module_args': {'path': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../machines/sitef-01.yml', 'follow': False, 'get_md5': False, 'get_checksum': True, 'get_mime': True, 'get_attributes': True, 'checksum_algorithm': 'sha1'}}, 'failed': False, 'item': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../machines/sitef-01.yml', 'ansible_loop_var': 'item'}) 
skipping: [localhost] => (item={'changed': False, 'stat': {'exists': False}, 'invocation': {'module_args': {'path': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../inventory/machines/sitef-01.yml', 'follow': False, 'get_md5': False, 'get_checksum': True, 'get_mime': True, 'get_attributes': True, 'checksum_algorithm': 'sha1'}}, 'failed': False, 'item': '/tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../inventory/machines/sitef-01.yml', 'ansible_loop_var': 'item'}) 
skipping: [localhost]
TASK [Falhar se arquivo da máquina não existir em nenhum caminho esperado] *****
fatal: [localhost]: FAILED! => {"changed": false, "msg": "Arquivo de máquina não encontrado para sitef-01.\nCaminhos testados:\n- /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/machines/sitef-01.yml\n- /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../execution/sitef-01.yml\n- /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../machines/sitef-01.yml\n- /tmp/tmp.Cv5NSOF379/elastic-compute-cloud-sitef/ansible/../inventory/machines/sitef-01.yml\n"}
PLAY RECAP *********************************************************************
localhost                  : ok=12   changed=1    unreachable=0    failed=1    skipped=2    rescued=0    ignored=0   
Command finished with status FAILURE

# predeploy_from_execution.yml
#
# PIPELINE 1 - PREDEPLOY
# - Lê execution/<arquivo>.yml
# - Para cada máquina:
#   * carrega machine + package
#   * exporta env_vars (merge)
#   * prepara área /opt/SoftwareExpress/sitef-pipeline/deploy
#   * limpa scripts
#   * copia package.yml
#   * baixa componentes do Nexus
#   * copia scripts do repo
#   * executa init_parallel.sh
#   * gera status JSON
#   * envia JSON + LOG para Harness File Store
#
# CORREÇÃO PRINCIPAL:
# - NÃO declarar filestore_env nem filestore_base_dir no vars
#   para evitar recursão caso o pipeline já injete essas variáveis.
# - Resolver valores com set_fact usando defaults seguros.

- name: "Predeploy a partir do arquivo de execução"
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # -------------------------------
    # Entradas principais
    # -------------------------------
    execution_file_name: "{{ execution_file_name | default('execution/machine_list_dev.yml') }}"
    deployment_ref: "{{ deployment_ref | default('DEV000000001') }}"

    # -------------------------------
    # Paths do repositório
    # -------------------------------
    repo_root_resolved: "{{ playbook_dir }}/.."
    status_dir_resolved: "{{ (playbook_dir ~ '/..') }}/status/{{ deployment_ref }}"

    # -------------------------------
    # Nexus (ideal vir do Harness Secrets)
    # -------------------------------
    nexus_base_url: "{{ nexus_base_url | default('https://nexus-ci.onefiserv.net/repository/raw-apm0004548-dev') }}"
    nexus_user: "{{ nexus_user | default(omit) }}"
    nexus_password: "{{ nexus_password | default(omit) }}"

  tasks:
    # ---------------------------------------
    # Resolver File Store sem recursão
    # ---------------------------------------
    - name: Resolver filestore_env e filestore_base_dir sem recursão
      ansible.builtin.set_fact:
        filestore_env_resolved: >-
          {{
            (filestore_env | string | trim)
              if (filestore_env is defined and (filestore_env | string | trim) | length > 0)
              else 'dev'
          }}
        filestore_base_dir_resolved: >-
          {{
            (filestore_base_dir | string | trim)
              if (filestore_base_dir is defined and (filestore_base_dir | string | trim) | length > 0)
              else (
                (
                  (filestore_env | string | trim)
                    if (filestore_env is defined and (filestore_env | string | trim) | length > 0)
                    else 'dev'
                ) ~ '/' ~ deployment_ref
              )
          }}

    # ---------------------------------------
    # Mostrar variáveis resolvidas
    # ---------------------------------------
    - name: "Mostrar variáveis de entrada e resolvidas"
      ansible.builtin.debug:
        msg:
          - "execution_file_name          = {{ execution_file_name }}"
          - "deployment_ref               = {{ deployment_ref }}"
          - "repo_root_resolved           = {{ repo_root_resolved }}"
          - "status_dir_resolved          = {{ status_dir_resolved }}"
          - "filestore_env_resolved       = {{ filestore_env_resolved }}"
          - "filestore_base_dir_resolved  = {{ filestore_base_dir_resolved }}"
          - "nexus_base_url               = {{ nexus_base_url }}"

    # ---------------------------------------
    # Criar diretório de status local
    # ---------------------------------------
    - name: "Criar diretório de status da TAG"
      ansible.builtin.file:
        path: "{{ status_dir_resolved }}"
        state: directory
        mode: "0755"

    # ---------------------------------------
    # Carregar arquivo de execução
    # ---------------------------------------
    - name: "Carregar arquivo de execução"
      ansible.builtin.include_vars:
        file: "{{ repo_root_resolved }}/{{ execution_file_name }}"
        name: execution_cfg

    # ---------------------------------------
    # Validar se há máquinas
    # ---------------------------------------
    - name: "Falhar se não tiver máquinas no arquivo de execução"
      ansible.builtin.fail:
        msg: "Nenhuma máquina encontrada em execution_cfg.machines"
      when: execution_cfg.machines is not defined or execution_cfg.machines | length == 0

    # ---------------------------------------
    # Executar pré-deploy por máquina
    # ---------------------------------------
    - name: "Executar pré-deploy por máquina"
      ansible.builtin.include_tasks: predeploy_per_machine.yml
      loop: "{{ execution_cfg.machines }}"
      loop_control:
        loop_var: machine_name
      vars:
        # Variáveis esperadas pelo tasks file
        deployment_ref: "{{ deployment_ref }}"
        repo_root: "{{ repo_root_resolved }}"
        status_dir: "{{ status_dir_resolved }}"

        nexus_base_url: "{{ nexus_base_url }}"
        nexus_user: "{{ nexus_user | default('') }}"
        nexus_password: "{{ nexus_password | default('') }}"

        filestore_env: "{{ filestore_env_resolved }}"
        filestore_base_dir: "{{ filestore_base_dir_resolved }}"

---
# =====================================================================================
# PREDEPLOY POR MÁQUINA
# Incluído pelo predeploy_from_execution.yml
# =====================================================================================

# -----------------------------------------------------------------------------
# 1) Resolver nome da máquina atual
# -----------------------------------------------------------------------------
- name: "Resolver nome da máquina atual"
  ansible.builtin.set_fact:
    current_machine: >-
      {{
        (machine_name | default(item) | default('')) | string | trim
      }}
  when: current_machine is not defined or (current_machine | string | trim) | length == 0

# -----------------------------------------------------------------------------
# 2) Definir paths base do repositório
# -----------------------------------------------------------------------------
- name: "Definir paths base do repositório"
  ansible.builtin.set_fact:
    repo_root_safe: >-
      {{
        repo_root_resolved
          | default(repo_root | default(playbook_dir ~ '/..'))
      }}

# -----------------------------------------------------------------------------
# 3) Definir diretórios principais do repositório (FIX)
#    IMPORTANTÍSSIMO: separar em tarefas para não referenciar variável criada
#    no mesmo set_fact.
# -----------------------------------------------------------------------------
- name: "Definir execution_dir do repositório"
  ansible.builtin.set_fact:
    execution_dir: "{{ repo_root_safe }}/execution"

- name: "Definir machines_dir e packages_dir do repositório"
  ansible.builtin.set_fact:
    machines_dir: "{{ execution_dir }}/machines"
    packages_dir: "{{ repo_root_safe }}/packages"

# -----------------------------------------------------------------------------
# 4) Candidatos de arquivo de máquina (robusto)
# -----------------------------------------------------------------------------
- name: "Definir candidatos de arquivo da máquina"
  ansible.builtin.set_fact:
    candidate_machine_files:
      - "{{ machines_dir }}/{{ current_machine }}.yml"
      - "{{ execution_dir }}/{{ current_machine }}.yml"
      - "{{ repo_root_safe }}/machines/{{ current_machine }}.yml"
      - "{{ repo_root_safe }}/inventory/machines/{{ current_machine }}.yml"

# -----------------------------------------------------------------------------
# 5) Verificar quais candidatos existem
# -----------------------------------------------------------------------------
- name: "Verificar candidatos de arquivo da máquina"
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ candidate_machine_files }}"
  register: machine_candidates_stat

# -----------------------------------------------------------------------------
# 6) Selecionar o primeiro arquivo existente
# -----------------------------------------------------------------------------
- name: "Selecionar machine_file existente"
  ansible.builtin.set_fact:
    machine_file: "{{ item.item }}"
  when:
    - item.stat.exists
    - machine_file is not defined
  loop: "{{ machine_candidates_stat.results }}"

# -----------------------------------------------------------------------------
# 7) Falhar se nenhum candidato existir
# -----------------------------------------------------------------------------
- name: "Falhar se arquivo da máquina não existir em nenhum caminho esperado"
  ansible.builtin.fail:
    msg: |
      Arquivo de máquina não encontrado para {{ current_machine }}.
      Caminhos testados:
      {{ candidate_machine_files | to_nice_yaml }}
  when: machine_file is not defined

# -----------------------------------------------------------------------------
# 8) Carregar config da máquina
# -----------------------------------------------------------------------------
- name: "Carregar config da máquina {{ current_machine }}"
  ansible.builtin.include_vars:
    file: "{{ machine_file }}"
    name: machine_cfg

# -----------------------------------------------------------------------------
# 9) Validar package definido
# -----------------------------------------------------------------------------
- name: "Validar package definido"
  ansible.builtin.assert:
    that:
      - machine_cfg is defined
      - machine_cfg.package is defined
      - (machine_cfg.package | string | trim) | length > 0
    fail_msg: "machine_cfg.package não definido em {{ machine_file }}"

# -----------------------------------------------------------------------------
# 10) Carregar config do pacote
# -----------------------------------------------------------------------------
- name: "Carregar config do pacote {{ machine_cfg.package }}"
  ansible.builtin.include_vars:
    file: "{{ packages_dir }}/{{ machine_cfg.package }}.yml"
    name: package_cfg

# -----------------------------------------------------------------------------
# 11) Validações mínimas do pacote (ajuste conforme padrão real)
# -----------------------------------------------------------------------------
- name: "Validar components do pacote"
  ansible.builtin.assert:
    that:
      - package_cfg is defined
      - package_cfg.components is defined
      - package_cfg.components | length > 0
    fail_msg: "components ausente/vazio no pacote {{ machine_cfg.package }}"

# -----------------------------------------------------------------------------
# 12) Usuário/SSH defaults
# -----------------------------------------------------------------------------
- name: "Definir usuário alvo padrão"
  ansible.builtin.set_fact:
    target_user: "{{ machine_cfg.target_user | default('root') }}"

- name: "Definir ssh_common_args padrão"
  ansible.builtin.set_fact:
    ssh_common_args: "{{ machine_cfg.ssh_common_args | default('-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null') }}"

- name: "Aplicar ProxyJump via bastion (quando necessário)"
  ansible.builtin.set_fact:
    ssh_common_args: >-
      {{ ssh_common_args }}
      -o ProxyJump={{ machine_cfg.bastion_user | default(target_user) }}@{{ machine_cfg.bastion_host }}
  when:
    - machine_cfg.bastion_host is defined
    - machine_cfg.bastion_host | string | length > 0

# -----------------------------------------------------------------------------
# 13) Registrar host dinâmico
# -----------------------------------------------------------------------------
- name: "Registrar host dinâmico para {{ current_machine }}"
  ansible.builtin.add_host:
    name: "{{ current_machine }}"
    ansible_host: "{{ machine_cfg.ip | default(machine_cfg.ansible_host) }}"
    ansible_user: "{{ target_user }}"
    ansible_ssh_common_args: "{{ ssh_common_args }}"
  changed_when: true

# -----------------------------------------------------------------------------
# 14) Definir caminhos de status e deploy
# -----------------------------------------------------------------------------
- name: "Definir caminhos de status e deploy"
  ansible.builtin.set_fact:
    machine_status_dir: "{{ status_dir_resolved }}/{{ current_machine }}"
    machine_status_file: "{{ machine_status_dir }}/status.json"

    deploy_base_dir: "/opt/SoftwareExpress/sitef-pipeline/deploy"
    deploy_scripts_dir: "/opt/SoftwareExpress/sitef-pipeline/deploy/scripts"
    deploy_scripts_package_dir: "/opt/SoftwareExpress/sitef-pipeline/deploy/scripts/package"

# -----------------------------------------------------------------------------
# 15) Criar status inicial (queued)
# -----------------------------------------------------------------------------
- name: "Criar diretório de status da máquina"
  ansible.builtin.file:
    path: "{{ machine_status_dir }}"
    state: directory
    mode: "0755"

- name: "Escrever status inicial (queued)"
  ansible.builtin.copy:
    dest: "{{ machine_status_file }}"
    mode: "0644"
    content: |
      {
        "machine": "{{ current_machine }}",
        "package": "{{ machine_cfg.package }}",
        "status": "queued",
        "deployment_ref": "{{ deployment_ref | default('') }}",
        "filestore_env": "{{ filestore_env_resolved | default('') }}",
        "filestore_base_dir": "{{ filestore_base_dir_resolved | default('') }}",
        "nexus_base_url": "{{ nexus_base_url | default('') }}"
      }
  changed_when: true

# -----------------------------------------------------------------------------
# 16) Garantir base do pipeline no host remoto
# -----------------------------------------------------------------------------
- name: "Garantir base do pipeline no host"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  become: true
  delegate_to: "{{ current_machine }}"
  loop:
    - "{{ deploy_base_dir }}"
    - "{{ deploy_scripts_dir }}"
    - "{{ deploy_scripts_package_dir }}"

# -----------------------------------------------------------------------------
# 17) Limpar pasta de scripts do pacote com segurança
# -----------------------------------------------------------------------------
- name: "Limpar pasta de scripts do pacote"
  ansible.builtin.file:
    path: "{{ deploy_scripts_package_dir }}"
    state: absent
  become: true
  delegate_to: "{{ current_machine }}"

- name: "Recriar pasta de scripts do pacote"
  ansible.builtin.file:
    path: "{{ deploy_scripts_package_dir }}"
    state: directory
    mode: "0755"
  become: true
  delegate_to: "{{ current_machine }}"

# -----------------------------------------------------------------------------
# 18) Atualizar status para predeploy_ready
# -----------------------------------------------------------------------------
- name: "Atualizar status para predeploy_ready"
  ansible.builtin.copy:
    dest: "{{ machine_status_file }}"
    mode: "0644"
    content: |
      {
        "machine": "{{ current_machine }}",
        "package": "{{ machine_cfg.package }}",
        "status": "predeploy_ready",
        "deployment_ref": "{{ deployment_ref | default('') }}",
        "filestore_env": "{{ filestore_env_resolved | default('') }}",
        "filestore_base_dir": "{{ filestore_base_dir_resolved | default('') }}",
        "nexus_base_url": "{{ nexus_base_url | default('') }}"
      }
  changed_when: true
