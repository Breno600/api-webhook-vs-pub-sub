Exec using JSCH
Connecting to 10.218.238.144 ....
Connection to 10.218.238.144 established
Executing command ...
export GIT_TAG=DEV000000006
== 1) Clonando repositorio (branch develop) ==
Cloning into '/tmp/elastic-compute-cloud-sitef'...
remote: Enumerating objects: 458, done.
remote: Counting objects:   0% (1/408)
remote: Counting objects:   1% (5/408)
remote: Counting objects:   2% (9/408)
remote: Counting objects:   3% (13/408)
remote: Counting objects:   4% (17/408)
remote: Counting objects:   5% (21/408)
remote: Counting objects:   6% (25/408)
remote: Counting objects:   7% (29/408)
remote: Counting objects:   8% (33/408)
remote: Counting objects:   9% (37/408)
remote: Counting objects:  10% (41/408)
remote: Counting objects:  11% (45/408)
remote: Counting objects:  12% (49/408)
remote: Counting objects:  13% (54/408)
remote: Counting objects:  14% (58/408)
remote: Counting objects:  15% (62/408)
remote: Counting objects:  16% (66/408)
remote: Counting objects:  17% (70/408)
remote: Counting objects:  18% (74/408)
remote: Counting objects:  19% (78/408)
remote: Counting objects:  20% (82/408)
remote: Counting objects:  21% (86/408)
remote: Counting objects:  22% (90/408)
remote: Counting objects:  23% (94/408)
remote: Counting objects:  24% (98/408)
remote: Counting objects:  25% (102/408)
remote: Counting objects:  26% (107/408)
remote: Counting objects:  27% (111/408)
remote: Counting objects:  28% (115/408)
remote: Counting objects:  29% (119/408)
remote: Counting objects:  30% (123/408)
remote: Counting objects:  31% (127/408)
remote: Counting objects:  32% (131/408)
remote: Counting objects:  33% (135/408)
remote: Counting objects:  34% (139/408)
remote: Counting objects:  35% (143/408)
remote: Counting objects:  36% (147/408)
remote: Counting objects:  37% (151/408)
remote: Counting objects:  38% (156/408)
remote: Counting objects:  39% (160/408)
remote: Counting objects:  40% (164/408)
remote: Counting objects:  41% (168/408)
remote: Counting objects:  42% (172/408)
remote: Counting objects:  43% (176/408)
remote: Counting objects:  44% (180/408)
remote: Counting objects:  45% (184/408)
remote: Counting objects:  46% (188/408)
remote: Counting objects:  47% (192/408)
remote: Counting objects:  48% (196/408)
remote: Counting objects:  49% (200/408)
remote: Counting objects:  50% (204/408)
remote: Counting objects:  51% (209/408)
remote: Counting objects:  52% (213/408)
remote: Counting objects:  53% (217/408)
remote: Counting objects:  54% (221/408)
remote: Counting objects:  55% (225/408)
remote: Counting objects:  56% (229/408)
remote: Counting objects:  57% (233/408)
remote: Counting objects:  58% (237/408)
remote: Counting objects:  59% (241/408)
remote: Counting objects:  60% (245/408)
remote: Counting objects:  61% (249/408)
remote: Counting objects:  62% (253/408)
remote: Counting objects:  63% (258/408)
remote: Counting objects:  64% (262/408)
remote: Counting objects:  65% (266/408)
remote: Counting objects:  66% (270/408)
remote: Counting objects:  67% (274/408)
remote: Counting objects:  68% (278/408)
remote: Counting objects:  69% (282/408)
remote: Counting objects:  70% (286/408)
remote: Counting objects:  71% (290/408)
remote: Counting objects:  72% (294/408)
remote: Counting objects:  73% (298/408)
remote: Counting objects:  74% (302/408)
remote: Counting objects:  75% (306/408)
remote: Counting objects:  76% (311/408)
remote: Counting objects:  77% (315/408)
remote: Counting objects:  78% (319/408)
remote: Counting objects:  79% (323/408)
remote: Counting objects:  80% (327/408)
remote: Counting objects:  81% (331/408)
remote: Counting objects:  82% (335/408)
remote: Counting objects:  83% (339/408)
remote: Counting objects:  84% (343/408)
remote: Counting objects:  85% (347/408)
remote: Counting objects:  86% (351/408)
remote: Counting objects:  87% (355/408)
remote: Counting objects:  88% (360/408)
remote: Counting objects:  89% (364/408)
remote: Counting objects:  90% (368/408)
remote: Counting objects:  91% (372/408)
remote: Counting objects:  92% (376/408)
remote: Counting objects:  93% (380/408)
remote: Counting objects:  94% (384/408)
remote: Counting objects:  95% (388/408)
remote: Counting objects:  96% (392/408)
remote: Counting objects:  97% (396/408)
remote: Counting objects:  98% (400/408)
remote: Counting objects:  99% (404/408)
remote: Counting objects: 100% (408/408)
remote: Counting objects: 100% (408/408), done.
remote: Compressing objects:   0% (1/395)
remote: Compressing objects:   1% (4/395)
remote: Compressing objects:   2% (8/395)
remote: Compressing objects:   3% (12/395)
remote: Compressing objects:   4% (16/395)
remote: Compressing objects:   5% (20/395)
remote: Compressing objects:   6% (24/395)
remote: Compressing objects:   7% (28/395)
remote: Compressing objects:   8% (32/395)
remote: Compressing objects:   9% (36/395)
remote: Compressing objects:  10% (40/395)
remote: Compressing objects:  11% (44/395)
remote: Compressing objects:  12% (48/395)
remote: Compressing objects:  13% (52/395)
remote: Compressing objects:  14% (56/395)
remote: Compressing objects:  15% (60/395)
remote: Compressing objects:  16% (64/395)
remote: Compressing objects:  17% (68/395)
remote: Compressing objects:  18% (72/395)
remote: Compressing objects:  19% (76/395)
remote: Compressing objects:  20% (79/395)
remote: Compressing objects:  21% (83/395)
remote: Compressing objects:  22% (87/395)
remote: Compressing objects:  23% (91/395)
remote: Compressing objects:  24% (95/395)
remote: Compressing objects:  25% (99/395)
remote: Compressing objects:  26% (103/395)
remote: Compressing objects:  27% (107/395)
remote: Compressing objects:  28% (111/395)
remote: Compressing objects:  29% (115/395)
remote: Compressing objects:  30% (119/395)
remote: Compressing objects:  31% (123/395)
remote: Compressing objects:  32% (127/395)
remote: Compressing objects:  33% (131/395)
remote: Compressing objects:  34% (135/395)
remote: Compressing objects:  35% (139/395)
remote: Compressing objects:  36% (143/395)
remote: Compressing objects:  37% (147/395)
remote: Compressing objects:  38% (151/395)
remote: Compressing objects:  39% (155/395)
remote: Compressing objects:  40% (158/395)
remote: Compressing objects:  41% (162/395)
remote: Compressing objects:  42% (166/395)
remote: Compressing objects:  43% (170/395)
remote: Compressing objects:  44% (174/395)
remote: Compressing objects:  45% (178/395)
remote: Compressing objects:  46% (182/395)
remote: Compressing objects:  47% (186/395)
remote: Compressing objects:  48% (190/395)
remote: Compressing objects:  49% (194/395)
remote: Compressing objects:  50% (198/395)
remote: Compressing objects:  51% (202/395)
remote: Compressing objects:  52% (206/395)
remote: Compressing objects:  53% (210/395)
remote: Compressing objects:  54% (214/395)
remote: Compressing objects:  55% (218/395)
remote: Compressing objects:  56% (222/395)
remote: Compressing objects:  57% (226/395)
remote: Compressing objects:  58% (230/395)
remote: Compressing objects:  59% (234/395)
remote: Compressing objects:  60% (237/395)
remote: Compressing objects:  61% (241/395)
remote: Compressing objects:  62% (245/395)
remote: Compressing objects:  63% (249/395)
remote: Compressing objects:  64% (253/395)
remote: Compressing objects:  65% (257/395)
remote: Compressing objects:  66% (261/395)
remote: Compressing objects:  67% (265/395)
remote: Compressing objects:  68% (269/395)
remote: Compressing objects:  69% (273/395)
remote: Compressing objects:  70% (277/395)
remote: Compressing objects:  71% (281/395)
remote: Compressing objects:  72% (285/395)
remote: Compressing objects:  73% (289/395)
remote: Compressing objects:  74% (293/395)
remote: Compressing objects:  75% (297/395)
remote: Compressing objects:  76% (301/395)
remote: Compressing objects:  77% (305/395)
remote: Compressing objects:  78% (309/395)
remote: Compressing objects:  79% (313/395)
remote: Compressing objects:  80% (316/395)
remote: Compressing objects:  81% (320/395)
remote: Compressing objects:  82% (324/395)
remote: Compressing objects:  83% (328/395)
remote: Compressing objects:  84% (332/395)
remote: Compressing objects:  85% (336/395)
remote: Compressing objects:  86% (340/395)
remote: Compressing objects:  87% (344/395)
remote: Compressing objects:  88% (348/395)
remote: Compressing objects:  89% (352/395)
remote: Compressing objects:  90% (356/395)
remote: Compressing objects:  91% (360/395)
remote: Compressing objects:  92% (364/395)
remote: Compressing objects:  93% (368/395)
remote: Compressing objects:  94% (372/395)
remote: Compressing objects:  95% (376/395)
remote: Compressing objects:  96% (380/395)
remote: Compressing objects:  97% (384/395)
remote: Compressing objects:  98% (388/395)
remote: Compressing objects:  99% (392/395)
remote: Compressing objects: 100% (395/395)
remote: Compressing objects: 100% (395/395), done.
remote: Total 458 (delta 231), reused 0 (delta 0), pack-reused 50
Receiving objects:   0% (1/458)
Receiving objects:   1% (5/458)
Receiving objects:   2% (10/458)
Receiving objects:   3% (14/458)
Receiving objects:   4% (19/458)
Receiving objects:   5% (23/458)
Receiving objects:   6% (28/458)
Receiving objects:   7% (33/458)
Receiving objects:   8% (37/458)
Receiving objects:   9% (42/458)
Receiving objects:  10% (46/458)
Receiving objects:  11% (51/458)
Receiving objects:  12% (55/458)
Receiving objects:  13% (60/458)
Receiving objects:  14% (65/458)
Receiving objects:  15% (69/458)
Receiving objects:  16% (74/458)
Receiving objects:  17% (78/458)
Receiving objects:  18% (83/458)
Receiving objects:  19% (88/458)
Receiving objects:  20% (92/458)
Receiving objects:  21% (97/458)
Receiving objects:  22% (101/458)
Receiving objects:  23% (106/458)
Receiving objects:  24% (110/458)
Receiving objects:  25% (115/458)
Receiving objects:  26% (120/458)
Receiving objects:  27% (124/458)
Receiving objects:  28% (129/458)
Receiving objects:  29% (133/458)
Receiving objects:  30% (138/458)
Receiving objects:  31% (142/458)
Receiving objects:  32% (147/458)
Receiving objects:  33% (152/458)
Receiving objects:  34% (156/458)
Receiving objects:  35% (161/458)
Receiving objects:  36% (165/458)
Receiving objects:  37% (170/458)
Receiving objects:  38% (175/458)
Receiving objects:  39% (179/458)
Receiving objects:  40% (184/458)
Receiving objects:  41% (188/458)
Receiving objects:  42% (193/458)
Receiving objects:  43% (197/458)
Receiving objects:  44% (202/458)
Receiving objects:  45% (207/458)
Receiving objects:  46% (211/458)
Receiving objects:  47% (216/458)
Receiving objects:  48% (220/458)
Receiving objects:  49% (225/458)
Receiving objects:  50% (229/458)
Receiving objects:  51% (234/458)
Receiving objects:  52% (239/458)
Receiving objects:  53% (243/458)
Receiving objects:  54% (248/458)
Receiving objects:  55% (252/458)
Receiving objects:  56% (257/458)
Receiving objects:  57% (262/458)
Receiving objects:  58% (266/458)
Receiving objects:  59% (271/458)
Receiving objects:  60% (275/458)
Receiving objects:  61% (280/458)
Receiving objects:  62% (284/458)
Receiving objects:  63% (289/458)
Receiving objects:  64% (294/458)
Receiving objects:  65% (298/458)
Receiving objects:  66% (303/458)
Receiving objects:  67% (307/458)
Receiving objects:  68% (312/458)
Receiving objects:  69% (317/458)
Receiving objects:  70% (321/458)
Receiving objects:  71% (326/458)
Receiving objects:  72% (330/458)
Receiving objects:  73% (335/458)
Receiving objects:  74% (339/458)
Receiving objects:  75% (344/458)
Receiving objects:  76% (349/458)
Receiving objects:  77% (353/458)
Receiving objects:  78% (358/458)
Receiving objects:  79% (362/458)
Receiving objects:  80% (367/458)
Receiving objects:  81% (371/458)
Receiving objects:  82% (376/458)
Receiving objects:  83% (381/458)
Receiving objects:  84% (385/458)
Receiving objects:  85% (390/458)
Receiving objects:  86% (394/458)
Receiving objects:  87% (399/458)
Receiving objects:  88% (404/458)
Receiving objects:  89% (408/458)
Receiving objects:  90% (413/458)
Receiving objects:  91% (417/458)
Receiving objects:  92% (422/458)
Receiving objects:  93% (426/458)
Receiving objects:  94% (431/458)
Receiving objects:  95% (436/458)
Receiving objects:  96% (440/458)
Receiving objects:  97% (445/458)
Receiving objects:  98% (449/458)
Receiving objects:  99% (454/458)
Receiving objects: 100% (458/458)
Receiving objects: 100% (458/458), 65.99 KiB | 16.50 MiB/s, done.
Resolving deltas:   0% (0/250)
Resolving deltas:   1% (3/250)
Resolving deltas:   2% (5/250)
Resolving deltas:   3% (8/250)
Resolving deltas:   4% (10/250)
Resolving deltas:   5% (13/250)
Resolving deltas:   6% (15/250)
Resolving deltas:   7% (18/250)
Resolving deltas:   8% (20/250)
Resolving deltas:   9% (23/250)
Resolving deltas:  10% (25/250)
Resolving deltas:  11% (28/250)
Resolving deltas:  12% (30/250)
Resolving deltas:  13% (33/250)
Resolving deltas:  14% (35/250)
Resolving deltas:  15% (38/250)
Resolving deltas:  16% (40/250)
Resolving deltas:  17% (43/250)
Resolving deltas:  18% (45/250)
Resolving deltas:  19% (48/250)
Resolving deltas:  20% (50/250)
Resolving deltas:  21% (53/250)
Resolving deltas:  22% (55/250)
Resolving deltas:  23% (58/250)
Resolving deltas:  24% (60/250)
Resolving deltas:  25% (63/250)
Resolving deltas:  26% (65/250)
Resolving deltas:  27% (68/250)
Resolving deltas:  28% (70/250)
Resolving deltas:  29% (73/250)
Resolving deltas:  30% (75/250)
Resolving deltas:  31% (78/250)
Resolving deltas:  32% (80/250)
Resolving deltas:  33% (83/250)
Resolving deltas:  34% (85/250)
Resolving deltas:  35% (88/250)
Resolving deltas:  36% (90/250)
Resolving deltas:  37% (93/250)
Resolving deltas:  38% (95/250)
Resolving deltas:  39% (98/250)
Resolving deltas:  40% (100/250)
Resolving deltas:  41% (103/250)
Resolving deltas:  42% (105/250)
Resolving deltas:  43% (108/250)
Resolving deltas:  44% (110/250)
Resolving deltas:  45% (113/250)
Resolving deltas:  46% (115/250)
Resolving deltas:  47% (118/250)
Resolving deltas:  48% (120/250)
Resolving deltas:  49% (123/250)
Resolving deltas:  50% (125/250)
Resolving deltas:  51% (128/250)
Resolving deltas:  52% (130/250)
Resolving deltas:  53% (133/250)
Resolving deltas:  54% (135/250)
Resolving deltas:  55% (138/250)
Resolving deltas:  56% (140/250)
Resolving deltas:  57% (143/250)
Resolving deltas:  58% (145/250)
Resolving deltas:  59% (148/250)
Resolving deltas:  60% (150/250)
Resolving deltas:  61% (153/250)
Resolving deltas:  62% (155/250)
Resolving deltas:  63% (158/250)
Resolving deltas:  64% (160/250)
Resolving deltas:  65% (163/250)
Resolving deltas:  66% (165/250)
Resolving deltas:  67% (168/250)
Resolving deltas:  68% (170/250)
Resolving deltas:  69% (173/250)
Resolving deltas:  70% (175/250)
Resolving deltas:  71% (178/250)
Resolving deltas:  72% (180/250)
Resolving deltas:  73% (183/250)
Resolving deltas:  74% (185/250)
Resolving deltas:  75% (188/250)
Resolving deltas:  76% (190/250)
Resolving deltas:  77% (193/250)
Resolving deltas:  78% (195/250)
Resolving deltas:  79% (198/250)
Resolving deltas:  80% (200/250)
Resolving deltas:  81% (203/250)
Resolving deltas:  82% (205/250)
Resolving deltas:  83% (208/250)
Resolving deltas:  84% (210/250)
Resolving deltas:  85% (213/250)
Resolving deltas:  86% (215/250)
Resolving deltas:  87% (218/250)
Resolving deltas:  88% (220/250)
Resolving deltas:  89% (223/250)
Resolving deltas:  90% (225/250)
Resolving deltas:  91% (228/250)
Resolving deltas:  92% (230/250)
Resolving deltas:  93% (233/250)
Resolving deltas:  94% (235/250)
Resolving deltas:  95% (238/250)
Resolving deltas:  96% (240/250)
Resolving deltas:  97% (243/250)
Resolving deltas:  98% (245/250)
Resolving deltas:  99% (248/250)
Resolving deltas: 100% (250/250)
Resolving deltas: 100% (250/250), done.
Repositorio em /tmp/elastic-compute-cloud-sitef
HEAD em:
develop
71be1bb90548480784cebc474d7fed2cb9657788
== 2) Rodando predeploy via Ansible ==
   TAG (deployment_ref): DEV000000006
   execution file      : execution/machine_list_dev.yml
[WARNING]: provided hosts list is empty, only localhost is available. Note that
the implicit localhost does not match 'all'
PLAY [Predeploy a partir do arquivo de execução] *******************************
TASK [Gathering Facts] *********************************************************
ok: [localhost]
TASK [Mostrar variáveis de entrada] ********************************************
ok: [localhost] => {
    "msg": [
        "execution_file_name = execution/machine_list_dev.yml",
        "deployment_ref     = DEV000000006",
        "repo_root          = /tmp/elastic-compute-cloud-sitef/ansible/..",
        "status_dir         = /tmp/elastic-compute-cloud-sitef/ansible/../status/DEV000000006"
    ]
}
TASK [Criar diretório de status da TAG] ****************************************
changed: [localhost]
TASK [Carregar arquivo de execução] ********************************************
ok: [localhost]
TASK [Exibir lista de máquinas] ************************************************
ok: [localhost] => {
    "execution_cfg.machines": [
        "sitef-01"
    ]
}
TASK [Falhar se não tiver máquinas no arquivo de execução] *********************
skipping: [localhost]
TASK [Executar pré-deploy por máquina] *****************************************
included: /tmp/elastic-compute-cloud-sitef/ansible/predeploy_per_machine.yml for localhost => (item=sitef-01)
TASK [Definir caminhos para sitef-01] ******************************************
ok: [localhost]
TASK [Carregar config da máquina sitef-01] *************************************
ok: [localhost]
TASK [Carregar config do pacote sitef-core-0.0.2-0] ****************************
ok: [localhost]
TASK [Definir usuário alvo padrão para sitef-01] *******************************
ok: [localhost]
TASK [Definir ssh_common_args padrão da máquina (se existir)] ******************
ok: [localhost]
TASK [Aplicar ProxyJump via bastion (quando necessário)] ***********************
skipping: [localhost]
TASK [Registrar host dinâmico para sitef-01] ***********************************
changed: [localhost]
TASK [Criar status inicial (queued) para sitef-01] *****************************
changed: [localhost]
TASK [Garantir diretórios base no host 100.99.41.58] ***************************
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef)
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef/package/linux)
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef/scripts)
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2)
TASK [Stat diretórios base no host 100.99.41.58] *******************************
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef)
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef/package/linux)
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef/scripts)
ok: [localhost -> sitef-01(100.99.41.58)] => (item=/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2)
TASK [debug] *******************************************************************
ok: [localhost] => {
    "dirs_stat": {
        "changed": false,
        "msg": "All items completed",
        "results": [
            {
                "ansible_loop_var": "item",
                "changed": false,
                "failed": false,
                "invocation": {
                    "module_args": {
                        "checksum_algorithm": "sha1",
                        "follow": false,
                        "get_attributes": true,
                        "get_checksum": true,
                        "get_md5": false,
                        "get_mime": true,
                        "path": "/opt/SoftwareExpress/sitef"
                    }
                },
                "item": "/opt/SoftwareExpress/sitef",
                "stat": {
                    "atime": 1765205117.281633,
                    "attr_flags": "",
                    "attributes": [],
                    "block_size": 4096,
                    "blocks": 8,
                    "charset": "binary",
                    "ctime": 1765202064.2182198,
                    "dev": 64779,
                    "device_type": 0,
                    "executable": true,
                    "exists": true,
                    "gid": 0,
                    "gr_name": "root",
                    "inode": 818688,
                    "isblk": false,
                    "ischr": false,
                    "isdir": true,
                    "isfifo": false,
                    "isgid": false,
                    "islnk": false,
                    "isreg": false,
                    "issock": false,
                    "isuid": false,
                    "mimetype": "inode/directory",
                    "mode": "0755",
                    "mtime": 1765202064.2182198,
                    "nlink": 19,
                    "path": "/opt/SoftwareExpress/sitef",
                    "pw_name": "root",
                    "readable": true,
                    "rgrp": true,
                    "roth": true,
                    "rusr": true,
                    "size": 4096,
                    "uid": 0,
                    "version": "116365434",
                    "wgrp": false,
                    "woth": false,
                    "writeable": true,
                    "wusr": true,
                    "xgrp": true,
                    "xoth": true,
                    "xusr": true
                }
            },
            {
                "ansible_loop_var": "item",
                "changed": false,
                "failed": false,
                "invocation": {
                    "module_args": {
                        "checksum_algorithm": "sha1",
                        "follow": false,
                        "get_attributes": true,
                        "get_checksum": true,
                        "get_md5": false,
                        "get_mime": true,
                        "path": "/opt/SoftwareExpress/sitef/package/linux"
                    }
                },
                "item": "/opt/SoftwareExpress/sitef/package/linux",
                "stat": {
                    "atime": 1765200869.6444714,
                    "attr_flags": "",
                    "attributes": [],
                    "block_size": 4096,
                    "blocks": 0,
                    "charset": "binary",
                    "ctime": 1765200861.8964338,
                    "dev": 64779,
                    "device_type": 0,
                    "executable": true,
                    "exists": true,
                    "gid": 0,
                    "gr_name": "root",
                    "inode": 818689,
                    "isblk": false,
                    "ischr": false,
                    "isdir": true,
                    "isfifo": false,
                    "isgid": false,
                    "islnk": false,
                    "isreg": false,
                    "issock": false,
                    "isuid": false,
                    "mimetype": "inode/directory",
                    "mode": "0755",
                    "mtime": 1765200861.8964338,
                    "nlink": 2,
                    "path": "/opt/SoftwareExpress/sitef/package/linux",
                    "pw_name": "root",
                    "readable": true,
                    "rgrp": true,
                    "roth": true,
                    "rusr": true,
                    "size": 80,
                    "uid": 0,
                    "version": "1235325711",
                    "wgrp": false,
                    "woth": false,
                    "writeable": true,
                    "wusr": true,
                    "xgrp": true,
                    "xoth": true,
                    "xusr": true
                }
            },
            {
                "ansible_loop_var": "item",
                "changed": false,
                "failed": false,
                "invocation": {
                    "module_args": {
                        "checksum_algorithm": "sha1",
                        "follow": false,
                        "get_attributes": true,
                        "get_checksum": true,
                        "get_md5": false,
                        "get_mime": true,
                        "path": "/opt/SoftwareExpress/sitef/scripts"
                    }
                },
                "item": "/opt/SoftwareExpress/sitef/scripts",
                "stat": {
                    "atime": 1765200869.6494713,
                    "attr_flags": "",
                    "attributes": [],
                    "block_size": 4096,
                    "blocks": 0,
                    "charset": "binary",
                    "ctime": 1765200856.96341,
                    "dev": 64779,
                    "device_type": 0,
                    "executable": true,
                    "exists": true,
                    "gid": 0,
                    "gr_name": "root",
                    "inode": 1179776,
                    "isblk": false,
                    "ischr": false,
                    "isdir": true,
                    "isfifo": false,
                    "isgid": false,
                    "islnk": false,
                    "isreg": false,
                    "issock": false,
                    "isuid": false,
                    "mimetype": "inode/directory",
                    "mode": "0755",
                    "mtime": 1765200856.96341,
                    "nlink": 4,
                    "path": "/opt/SoftwareExpress/sitef/scripts",
                    "pw_name": "root",
                    "readable": true,
                    "rgrp": true,
                    "roth": true,
                    "rusr": true,
                    "size": 58,
                    "uid": 0,
                    "version": "3080685529",
                    "wgrp": false,
                    "woth": false,
                    "writeable": true,
                    "wusr": true,
                    "xgrp": true,
                    "xoth": true,
                    "xusr": true
                }
            },
            {
                "ansible_loop_var": "item",
                "changed": false,
                "failed": false,
                "invocation": {
                    "module_args": {
                        "checksum_algorithm": "sha1",
                        "follow": false,
                        "get_attributes": true,
                        "get_checksum": true,
                        "get_md5": false,
                        "get_mime": true,
                        "path": "/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2"
                    }
                },
                "item": "/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2",
                "stat": {
                    "atime": 1765202064.9962234,
                    "attr_flags": "",
                    "attributes": [],
                    "block_size": 4096,
                    "blocks": 0,
                    "charset": "binary",
                    "ctime": 1765201963.0467377,
                    "dev": 64779,
                    "device_type": 0,
                    "executable": true,
                    "exists": true,
                    "gid": 0,
                    "gr_name": "root",
                    "inode": 818703,
                    "isblk": false,
                    "ischr": false,
                    "isdir": true,
                    "isfifo": false,
                    "isgid": false,
                    "islnk": false,
                    "isreg": false,
                    "issock": false,
                    "isuid": false,
                    "mimetype": "inode/directory",
                    "mode": "0755",
                    "mtime": 1765201963.0467377,
                    "nlink": 2,
                    "path": "/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2",
                    "pw_name": "root",
                    "readable": true,
                    "rgrp": true,
                    "roth": true,
                    "rusr": true,
                    "size": 87,
                    "uid": 0,
                    "version": "2406724834",
                    "wgrp": false,
                    "woth": false,
                    "writeable": true,
                    "wusr": true,
                    "xgrp": true,
                    "xoth": true,
                    "xusr": true
                }
            }
        ],
        "skipped": false
    }
}
TASK [Baixar componentes do package sitef-core-0.0.2-0 para sitef-01] **********
ok: [localhost -> sitef-01(100.99.41.58)] => (item=packages/linux/sitef-core-0.0.2-0.x86_64.rpm)
TASK [debug] *******************************************************************
ok: [localhost] => {
    "geturl_result": {
        "changed": false,
        "msg": "All items completed",
        "results": [
            {
                "ansible_loop_var": "item",
                "changed": false,
                "checksum_dest": "a93a9a0f850ad14ffc1d42c5d5d8406c3e8b9250",
                "checksum_src": "a93a9a0f850ad14ffc1d42c5d5d8406c3e8b9250",
                "dest": "/opt/SoftwareExpress/sitef/package/linux/sitef-core-0.0.2-0.x86_64.rpm",
                "elapsed": 1,
                "failed": false,
                "gid": 0,
                "group": "root",
                "invocation": {
                    "module_args": {
                        "attributes": null,
                        "backup": false,
                        "checksum": "",
                        "ciphers": null,
                        "client_cert": null,
                        "client_key": null,
                        "decompress": true,
                        "dest": "/opt/SoftwareExpress/sitef/package/linux/sitef-core-0.0.2-0.x86_64.rpm",
                        "force": true,
                        "force_basic_auth": false,
                        "group": null,
                        "headers": null,
                        "http_agent": "ansible-httpget",
                        "mode": "0644",
                        "owner": null,
                        "selevel": null,
                        "serole": null,
                        "setype": null,
                        "seuser": null,
                        "timeout": 10,
                        "tmp_dest": null,
                        "unredirected_headers": [],
                        "unsafe_writes": false,
                        "url": "https://nexus-ci.onefiserv.net/repository/raw-apm0004548-dev/packages/linux/sitef-core-0.0.2-0.x86_64.rpm",
                        "url_password": "VALUE_SPECIFIED_IN_NO_LOG_PARAMETER",
                        "url_username": "AS4hZF20",
                        "use_gssapi": false,
                        "use_netrc": true,
                        "use_proxy": true,
                        "validate_certs": true
                    }
                },
                "item": "packages/linux/sitef-core-0.0.2-0.x86_64.rpm",
                "md5sum": "2195bb7c5379730daefa4aa441ac8be7",
                "mode": "0644",
                "msg": "OK (31504 bytes)",
                "owner": "root",
                "secontext": "system_u:object_r:usr_t:s0",
                "size": 31504,
                "src": "/home/ec2-user/.ansible/tmp/ansible-tmp-1765215825.9467845-140888-7037750060319/tmpd0io5hf6",
                "state": "file",
                "status_code": 200,
                "uid": 0,
                "url": "https://nexus-ci.onefiserv.net/repository/raw-apm0004548-dev/packages/linux/sitef-core-0.0.2-0.x86_64.rpm"
            }
        ],
        "skipped": false
    }
}
TASK [Verificar se RPM foi criado em 100.99.41.58] *****************************
ok: [localhost -> sitef-01(100.99.41.58)]
TASK [debug] *******************************************************************
ok: [localhost] => {
    "rpm_stat": {
        "changed": false,
        "failed": false,
        "stat": {
            "atime": 1765200862.6344373,
            "attr_flags": "",
            "attributes": [],
            "block_size": 4096,
            "blocks": 64,
            "charset": "binary",
            "checksum": "a93a9a0f850ad14ffc1d42c5d5d8406c3e8b9250",
            "ctime": 1765200861.8974338,
            "dev": 64779,
            "device_type": 0,
            "executable": false,
            "exists": true,
            "gid": 0,
            "gr_name": "root",
            "inode": 818704,
            "isblk": false,
            "ischr": false,
            "isdir": false,
            "isfifo": false,
            "isgid": false,
            "islnk": false,
            "isreg": true,
            "issock": false,
            "isuid": false,
            "mimetype": "application/x-rpm",
            "mode": "0644",
            "mtime": 1765200861.8914337,
            "nlink": 1,
            "path": "/opt/SoftwareExpress/sitef/package/linux/sitef-core-0.0.2-0.x86_64.rpm",
            "pw_name": "root",
            "readable": true,
            "rgrp": true,
            "roth": true,
            "rusr": true,
            "size": 31504,
            "uid": 0,
            "version": "3462471477",
            "wgrp": false,
            "woth": false,
            "writeable": true,
            "wusr": true,
            "xgrp": false,
            "xoth": false,
            "xusr": false
        }
    }
}
TASK [Falhar se RPM não existir em /opt/SoftwareExpress/sitef/package/linux na máquina 100.99.41.58] ***
skipping: [localhost]
TASK [Copiar scripts do package sitef-core-0.0.2-0 para sitef-01] **************
changed: [localhost -> sitef-01(100.99.41.58)]
TASK [debug] *******************************************************************
ok: [localhost] => {
    "copy_scripts_result": {
        "changed": true,
        "dest": "/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2/",
        "failed": false,
        "src": "/tmp/elastic-compute-cloud-sitef/scripts/deploy-sitef-0.0.2/"
    }
}
TASK [Verificar se init_parallel.sh existe na máquina alvo] ********************
ok: [localhost -> sitef-01(100.99.41.58)]
TASK [debug] *******************************************************************
ok: [localhost] => {
    "init_stat": {
        "changed": false,
        "failed": false,
        "stat": {
            "atime": 1765215831.4455988,
            "attr_flags": "",
            "attributes": [],
            "block_size": 4096,
            "blocks": 8,
            "charset": "us-ascii",
            "checksum": "2e1d235c049a782e4a189fa51278a70b83384be5",
            "ctime": 1765215831.4455988,
            "dev": 64779,
            "device_type": 0,
            "executable": true,
            "exists": true,
            "gid": 0,
            "gr_name": "root",
            "inode": 818705,
            "isblk": false,
            "ischr": false,
            "isdir": false,
            "isfifo": false,
            "isgid": false,
            "islnk": false,
            "isreg": true,
            "issock": false,
            "isuid": false,
            "mimetype": "text/x-shellscript",
            "mode": "0755",
            "mtime": 1765215831.051597,
            "nlink": 1,
            "path": "/opt/SoftwareExpress/sitef/scripts/deploy-sitef-0.0.2/init_parallel.sh",
            "pw_name": "root",
            "readable": true,
            "rgrp": true,
            "roth": true,
            "rusr": true,
            "size": 468,
            "uid": 0,
            "version": "3637278229",
            "wgrp": false,
            "woth": false,
            "writeable": true,
            "wusr": true,
            "xgrp": true,
            "xoth": true,
            "xusr": true
        }
    }
}
TASK [Falhar se init_parallel.sh não existir na máquina 100.99.41.58] **********
skipping: [localhost]
TASK [Executar script de pré-deploy (init_parallel.sh) em sitef-01] ************
changed: [localhost -> sitef-01(100.99.41.58)]
TASK [PROVA: criar marcador único no host alvo (sitef-01)] *********************
changed: [localhost -> sitef-01(100.99.41.58)]
TASK [debug] *******************************************************************
ok: [localhost] => {
    "probe_copy": {
        "changed": true,
        "checksum": "d5f3f6957d701e626657852321c2f1e31fbb097a",
        "dest": "/opt/SoftwareExpress/sitef/.predeploy_probe_DEV000000006_sitef-01_1765215817",
        "diff": [],
        "failed": false,
        "gid": 0,
        "group": "root",
        "md5sum": "6593f30b984d0167ff9e6bb97e42859b",
        "mode": "0644",
        "owner": "root",
        "secontext": "system_u:object_r:usr_t:s0",
        "size": 115,
        "src": "/home/ec2-user/.ansible/tmp/ansible-tmp-1765215902.224796-141191-146057774495035/source",
        "state": "file",
        "uid": 0
    }
}
TASK [PROVA: capturar identidade e listar evidências no host (sitef-01)] *******
changed: [localhost -> sitef-01(100.99.41.58)]
TASK [debug] *******************************************************************
ok: [localhost] => {
    "probe_ls.stdout_lines": [
        "=== HOST IDENTIDADE ===",
        "machine_name=sitef-01",
        "machine_cfg.host=100.99.41.58",
        "package=sitef-core-0.0.2-0",
        "deployment_ref=DEV000000006",
        "--- hostname ---",
        "LZFKDVAP1237.1dc.com",
        "--- ips ---",
        "100.99.41.58 ",
        "",
        "=== LISTAGEM BASE ===",
        "drwxr-xr-x. 10 root root  134 Nov 25 10:08 /opt",
        "drwxr-xr-x.  4 root root   38 Dec  8 17:44 /opt/SoftwareExpress",
        "drwxr-xr-x. 19 root root 4096 Dec  8 17:45 /opt/SoftwareExpress/sitef",
        "",
        "=== LISTAGEM PACKAGE ===",
        "total 68",
        "drwxr-xr-x. 2 root root    80 Dec  8 13:34 .",
        "drwxr-xr-x. 3 root root    19 Dec  5 10:48 ..",
        "-rw-r--r--. 1 root root 34016 Dec  5 10:48 sitef-core-0.0.1-0.x86_64.rpm",
        "-rw-r--r--. 1 root root 31504 Dec  8 13:34 sitef-core-0.0.2-0.x86_64.rpm",
        "",
        "=== LISTAGEM SCRIPTS ===",
        "total 8",
        "drwxr-xr-x.  4 root root   58 Dec  8 13:34 .",
        "drwxr-xr-x. 19 root root 4096 Dec  8 17:45 ..",
        "drwxr-xr-x.  2 root root   65 Dec  5 11:25 deploy-sitef-0.0.1",
        "drwxr-xr-x.  3 root root 4096 Dec  8 17:45 deploy-sitef-0.0.2",
        "total 48",
        "drwxr-xr-x. 3 root root 4096 Dec  8 17:45 .",
        "drwxr-xr-x. 4 root root   58 Dec  8 13:34 ..",
        "-rwxr-xr-x. 1 root root 5425 Dec  8 17:43 backup.py",
        "-rwxr-xr-x. 1 root root  468 Dec  8 17:43 init_parallel.sh",
        "-rwxr-xr-x. 1 root root  681 Dec  8 17:43 init.sh",
        "-rwxr-xr-x. 1 root root   93 Dec  8 13:52 install_rpm.sh",
        "-rw-r-----. 1 root root   39 Dec  8 13:54 parallel.txt",
        "drwxr-x---. 2 root root   63 Dec  8 17:45 __pycache__",
        "-rwxr-xr-x. 1 root root  740 Dec  8 17:43 script_deploy.py",
        "-rwxr-xr-x. 1 root root  175 Dec  8 17:43 script_prepare.py",
        "-rwxr-xr-x. 1 root root  677 Dec  8 17:43 script_rollback.py",
        "-rwxr-xr-x. 1 root root 1305 Dec  8 17:43 sitef_packages.py",
        "-rwxr-xr-x. 1 root root 3283 Dec  8 17:43 sitef.py",
        "",
        "=== PROBES ===",
        "",
        "=== PARALLEL.TXT ===",
        "Executando backup...",
        "Backup finalizado"
    ]
}
TASK [Atualizar status para success de sitef-01] *******************************
changed: [localhost]
TASK [Atualizar status para failed de sitef-01] ********************************
skipping: [localhost]
PLAY RECAP *********************************************************************
localhost                  : ok=30   changed=8    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   
== 3) Verificando se houve alteracoes em status/DEV000000006 ==
On branch develop
Your branch is up to date with 'origin/develop'.
Untracked files:
  (use "git add &lt;file>..." to include in what will be committed)
	status/DEV000000006/
nothing added to commit but untracked files present (use "git add" to track)
== 4) Fazendo commit e push das mudancas de status ==
[develop dc072b2] Predeploy status for DEV000000006 (execution execution/machine_list_dev.yml)
 1 file changed, 1 insertion(+)
 create mode 100644 status/DEV000000006/predeploy-sitef-01.json
Enumerating objects: 7, done.
Counting objects:  14% (1/7)
Counting objects:  28% (2/7)
Counting objects:  42% (3/7)
Counting objects:  57% (4/7)
Counting objects:  71% (5/7)
Counting objects:  85% (6/7)
Counting objects: 100% (7/7)
Counting objects: 100% (7/7), done.
Delta compression using up to 2 threads
Compressing objects:  20% (1/5)
Compressing objects:  40% (2/5)
Compressing objects:  60% (3/5)
Compressing objects:  80% (4/5)
Compressing objects: 100% (5/5)
Compressing objects: 100% (5/5), done.
Writing objects:  20% (1/5)
Writing objects:  40% (2/5)
Writing objects:  60% (3/5)
Writing objects:  80% (4/5)
Writing objects: 100% (5/5)
Writing objects: 100% (5/5), 1.96 KiB | 1.96 MiB/s, done.
Total 5 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
remote: 
remote: ========================================================================
remote: 
remote:   **Scheduled Change Notice ⚠️: GitLab** On **Tuesday, 12/9/2025,
remote:     from 5PM ET to 9 PM ET**, an update will be performed to resolve
remote:       intermittent GitLab 500 errors. No service interruptions are
remote:                                expected.
remote: 
remote: ========================================================================
remote: 
remote: 
remote: To create a merge request for develop, visit:
remote:   https://gitlab.onefiserv.net/latam/latam/merchant-latam/LAC/aws-cd-configuration/elastic-compute-cloud-sitef/-/merge_requests/new?merge_request%5Bsource_branch%5D=develop
remote: 
To https://gitlab.onefiserv.net/latam/latam/merchant-latam/LAC/aws-cd-configuration/elastic-compute-cloud-sitef.git
   71be1bb..dc072b2  develop -> develop
Commit de status enviado com sucesso para develop.
Command finished with status SUCCESS


# ansible/predeploy_from_execution.yml
#
# PIPELINE 1 - PREDEPLOY (PARTE LEVE)
# - Lê execution/<arquivo>.yml (lista de máquinas)
# - Para cada máquina chama predeploy_per_machine.yml (em loop)
# - Cada máquina ganha um JSON em status/<TAG>/predeploy-<machine>.json

- name: "Predeploy a partir do arquivo de execução"
  hosts: localhost
  connection: local
  gather_facts: true   # preciso de ansible_date_time p/ timestamp

  vars:
    # Vêm da pipeline via -e
    execution_file_name: "{{ execution_file_name | default('execution/machine_list_dev.yml') }}"
    deployment_ref: "{{ deployment_ref | default('DEV000000001') }}"

    repo_root: "{{ playbook_dir }}/.."
    status_dir: "{{ repo_root }}/status/{{ deployment_ref }}"

    nexus_base_url: "https://nexus-ci.onefiserv.net/repository/raw-apm0004548-dev"
    nexus_user: "AS4hZF20"
    nexus_password: "l7WwGfJd_Grmh-5Kn7B__U8nqgdNWh1XhrYtVQQ5I_6k"

  tasks:

    - name: "Mostrar variáveis de entrada"
      debug:
        msg:
          - "execution_file_name = {{ execution_file_name }}"
          - "deployment_ref     = {{ deployment_ref }}"
          - "repo_root          = {{ repo_root }}"
          - "status_dir         = {{ status_dir }}"

    - name: "Criar diretório de status da TAG"
      ansible.builtin.file:
        path: "{{ status_dir }}"
        state: directory
        mode: "0755"

    # Carrega o arquivo de execução
    # execution/machine_list_dev.yml
    # machines:
    #   - sitef-01
    #   - sitef-02
    - name: "Carregar arquivo de execução"
      ansible.builtin.include_vars:
        file: "{{ repo_root }}/{{ execution_file_name }}"
        name: execution_cfg

    - name: "Exibir lista de máquinas"
      debug:
        var: execution_cfg.machines

    - name: "Falhar se não tiver máquinas no arquivo de execução"
      ansible.builtin.fail:
        msg: "Nenhuma máquina encontrada em execution_cfg.machines"
      when: >
        execution_cfg.machines is not defined or
        execution_cfg.machines | length == 0

    # ------------------------------------------------------------------
    # Loop chamando o arquivo de tarefas por máquina
    # ------------------------------------------------------------------
    - name: "Executar pré-deploy por máquina"
      ansible.builtin.include_tasks: predeploy_per_machine.yml
      loop: "{{ execution_cfg.machines }}"
      loop_control:
        loop_var: machine_name


# ansible/predeploy_per_machine.yml
#
# Tarefas executadas para CADA máquina no pré-deploy.
# Variáveis de contexto (vêm do loop do play principal):
#   - machine_name
#   - repo_root
#   - status_dir
#   - deployment_ref
#
# Este arquivo foi ajustado para:
#   1) Evitar execução "local" acidental no bastion/controller
#   2) Garantir que delegate realmente execute no host alvo
#   3) Suportar bastion via ProxyJump opcional
#
# Como usar bastion:
#   - Cenário A (mais comum no seu fluxo):
#       O pipeline conecta no bastion via JSCH
#       e roda ansible *de dentro do bastion*.
#       => NÃO precisa ProxyJump.
#
#   - Cenário B:
#       Você roda ansible de fora da rede privada.
#       => Defina em algum lugar do play principal ou vars:
#            bastion_host: "SEU_IP_OU_DNS_DO_BASTION"
#            bastion_user: "ec2-user"
#         ou defina machine_cfg.ssh_common_args por máquina.
#
# Obs:
#   Este arquivo tenta respeitar machine/<nome>.yml usando:
#     machine_cfg.user (opcional)
#     machine_cfg.env_vars (opcional)
#     machine_cfg.ssh_common_args (opcional)
#     machine_cfg.package
#     machine_cfg.host

# ----------------------------------------------------------
# Definir caminhos locais de trabalho
# ----------------------------------------------------------
- name: "Definir caminhos para {{ machine_name }}"
  ansible.builtin.set_fact:
    machine_file: "{{ repo_root }}/machine/{{ machine_name }}.yml"
    status_file: "{{ status_dir }}/predeploy-{{ machine_name }}.json"
    host_base_dir: "/opt/SoftwareExpress/sitef"
    host_pkg_dir: "/opt/SoftwareExpress/sitef/package/linux"
    host_scripts_dir: "/opt/SoftwareExpress/sitef/scripts"

# ----------------------------------------------------------
# Carregar configs
# ----------------------------------------------------------
- name: "Carregar config da máquina {{ machine_name }}"
  ansible.builtin.include_vars:
    file: "{{ machine_file }}"
    name: machine_cfg

- name: "Carregar config do pacote {{ machine_cfg.package }}"
  ansible.builtin.include_vars:
    file: "{{ repo_root }}/package/{{ machine_cfg.package }}.yml"
    name: package_cfg

# ----------------------------------------------------------
# Calcular SSH args (com suporte a bastion opcional)
# ----------------------------------------------------------
- name: "Definir usuário alvo padrão para {{ machine_name }}"
  ansible.builtin.set_fact:
    target_user: "{{ machine_cfg.user | default('ec2-user') }}"

- name: "Definir ssh_common_args padrão da máquina (se existir)"
  ansible.builtin.set_fact:
    target_ssh_common_args: "{{ machine_cfg.ssh_common_args | default('') }}"

# Só aplica ProxyJump se:
#  - a máquina NÃO definiu ssh_common_args
#  - bastion_host foi definido em vars do play/pipeline
- name: "Aplicar ProxyJump via bastion (quando necessário)"
  ansible.builtin.set_fact:
    target_ssh_common_args: "-o ProxyJump={{ bastion_user | default('ec2-user') }}@{{ bastion_host }}"
  when:
    - (target_ssh_common_args | length) == 0
    - bastion_host is defined


# ----------------------------------------------------------
# Registrar host dinâmico para GARANTIR conexão SSH real
# Isso evita o problema de "localhost/connection local"
# ----------------------------------------------------------
- name: "Registrar host dinâmico para {{ machine_name }}"
  ansible.builtin.add_host:
    name: "{{ machine_name }}"
    ansible_host: "{{ machine_cfg.host }}"
    ansible_user: "{{ target_user }}"
    ansible_connection: ssh
    ansible_ssh_common_args: "{{ target_ssh_common_args }}"

# ----------------------------------------------------------
# Status inicial (queued)
# ----------------------------------------------------------
- name: "Criar status inicial (queued) para {{ machine_name }}"
  ansible.builtin.copy:
    dest: "{{ status_file }}"
    content: |
      {
        "machine": "{{ machine_name }}",
        "host": "{{ machine_cfg.host }}",
        "package": "{{ machine_cfg.package }}",
        "rollback": "{{ machine_cfg.rollback | default('') }}",
        "status": "queued",
        "deployment_ref": "{{ deployment_ref }}",
        "timestamp": "{{ ansible_date_time.iso8601 }}"
      }

# ----------------------------------------------------------
# Criar diretórios NA MÁQUINA ALVO
# ----------------------------------------------------------
- name: "Garantir diretórios base no host {{ machine_cfg.host }}"
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: root
    group: root
  loop:
    - "{{ host_base_dir }}"
    - "{{ host_pkg_dir }}"
    - "{{ host_scripts_dir }}"
    - "{{ host_scripts_dir }}/{{ package_cfg.script }}"
  delegate_to: "{{ machine_name }}"

# (Opcional mas útil) Provar no log que os diretórios existem do ponto de vista do host alvo
- name: "Stat diretórios base no host {{ machine_cfg.host }}"
  become: true
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ host_base_dir }}"
    - "{{ host_pkg_dir }}"
    - "{{ host_scripts_dir }}"
    - "{{ host_scripts_dir }}/{{ package_cfg.script }}"
  delegate_to: "{{ machine_name }}"
  register: dirs_stat

- debug:
    var: dirs_stat

# ----------------------------------------------------------
# Baixar RPM(s) do Nexus na MÁQUINA ALVO
# package_cfg.components:
#   - packages/linux/sitef-core-0.0.1-0.x86_64.rpm
# ----------------------------------------------------------
- name: "Baixar componentes do package {{ machine_cfg.package }} para {{ machine_name }}"
  become: true
  ansible.builtin.get_url:
    url: "{{ nexus_base_url }}/{{ item }}"
    dest: "{{ host_pkg_dir }}/{{ item | basename }}"
    mode: "0644"
    url_username: "{{ nexus_user }}"
    url_password: "{{ nexus_password }}"
    force: true
  loop: "{{ package_cfg.components }}"
  delegate_to: "{{ machine_name }}"
  register: geturl_result

- debug:
    var: geturl_result

# Verificar se o RPM realmente apareceu na máquina alvo
- name: "Verificar se RPM foi criado em {{ machine_cfg.host }}"
  become: true
  ansible.builtin.stat:
    path: "{{ host_pkg_dir }}/{{ (package_cfg.components[0] | basename) }}"
  delegate_to: "{{ machine_name }}"
  register: rpm_stat

- debug:
    var: rpm_stat

- name: "Falhar se RPM não existir em {{ host_pkg_dir }} na máquina {{ machine_cfg.host }}"
  ansible.builtin.fail:
    msg: "RPM {{ package_cfg.components[0] | basename }} não encontrado em {{ host_pkg_dir }} na máquina {{ machine_cfg.host }}"
  when: not rpm_stat.stat.exists

# ----------------------------------------------------------
# Copiar scripts do package para a máquina alvo
# scripts/<script>/...
# ----------------------------------------------------------
- name: "Copiar scripts do package {{ machine_cfg.package }} para {{ machine_name }}"
  become: true
  ansible.builtin.copy:
    src: "{{ repo_root }}/scripts/{{ package_cfg.script }}/"
    dest: "{{ host_scripts_dir }}/{{ package_cfg.script }}/"
    mode: "0755"
  delegate_to: "{{ machine_name }}"
  register: copy_scripts_result

- debug:
    var: copy_scripts_result

# Verificar se o init_parallel.sh está na máquina alvo
- name: "Verificar se init_parallel.sh existe na máquina alvo"
  become: true
  ansible.builtin.stat:
    path: "{{ host_scripts_dir }}/{{ package_cfg.script }}/init_parallel.sh"
  delegate_to: "{{ machine_name }}"
  register: init_stat

- debug:
    var: init_stat

- name: "Falhar se init_parallel.sh não existir na máquina {{ machine_cfg.host }}"
  ansible.builtin.fail:
    msg: "init_parallel.sh não encontrado em {{ host_scripts_dir }}/{{ package_cfg.script }} na máquina {{ machine_cfg.host }}"
  when: not init_stat.stat.exists

# ----------------------------------------------------------
# Executar o init_parallel.sh NA MÁQUINA ALVO
# Usando env_vars definidos no machine/<nome>.yml
# ----------------------------------------------------------
- name: "Executar script de pré-deploy (init_parallel.sh) em {{ machine_name }}"
  become: true
  ansible.builtin.shell: |
    cd "{{ host_scripts_dir }}/{{ package_cfg.script }}"
    ./init_parallel.sh
  delegate_to: "{{ machine_name }}"
  environment: "{{ machine_cfg.env_vars | default({}) }}"
  register: predeploy_result
  ignore_errors: true

# ----------------------------------------------------------
# PROVA DEFINITIVA DE IDENTIDADE DO HOST + EVIDÊNCIAS NO LOG
# ----------------------------------------------------------
- name: "PROVA: criar marcador único no host alvo ({{ machine_name }})"
  become: true
  ansible.builtin.copy:
    dest: "{{ host_base_dir }}/.predeploy_probe_{{ deployment_ref }}_{{ machine_name }}_{{ ansible_date_time.epoch }}"
    mode: "0644"
    content: |
      machine={{ machine_name }}
      host={{ machine_cfg.host }}
      package={{ machine_cfg.package }}
      deployment_ref={{ deployment_ref }}
      ansible_epoch={{ ansible_date_time.epoch }}
  delegate_to: "{{ machine_name }}"
  register: probe_copy

- debug:
    var: probe_copy

- name: "PROVA: capturar identidade e listar evidências no host ({{ machine_name }})"
  become: true
  ansible.builtin.shell: |
    echo "=== HOST IDENTIDADE ==="
    echo "machine_name={{ machine_name }}"
    echo "machine_cfg.host={{ machine_cfg.host }}"
    echo "package={{ machine_cfg.package }}"
    echo "deployment_ref={{ deployment_ref }}"
    echo "--- hostname ---"
    hostname
    echo "--- ips ---"
    hostname -I || ip a
    echo
    echo "=== LISTAGEM BASE ==="
    ls -ld /opt /opt/SoftwareExpress "{{ host_base_dir }}" || true
    echo
    echo "=== LISTAGEM PACKAGE ==="
    ls -la "{{ host_pkg_dir }}" || true
    echo
    echo "=== LISTAGEM SCRIPTS ==="
    ls -la "{{ host_scripts_dir }}" || true
    ls -la "{{ host_scripts_dir }}/{{ package_cfg.script }}" || true
    echo
    echo "=== PROBES ==="
    ls -la "{{ host_base_dir }}/.predeploy_probe_*" || true
    echo
    echo "=== PARALLEL.TXT ==="
    cat "{{ host_scripts_dir }}/{{ package_cfg.script }}/parallel.txt" || echo "parallel.txt nao existe"
  delegate_to: "{{ machine_name }}"
  register: probe_ls

- debug:
    var: probe_ls.stdout_lines

# ----------------------------------------------------------
# Atualizar status para success ou failed
# ----------------------------------------------------------
- name: "Atualizar status para success de {{ machine_name }}"
  ansible.builtin.copy:
    dest: "{{ status_file }}"
    content: |
      {
        "machine": "{{ machine_name }}",
        "host": "{{ machine_cfg.host }}",
        "package": "{{ machine_cfg.package }}",
        "rollback": "{{ machine_cfg.rollback | default('') }}",
        "status": "success",
        "deployment_ref": "{{ deployment_ref }}",
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "stdout": {{ predeploy_result.stdout | to_json }},
        "stderr": {{ predeploy_result.stderr | to_json }}
      }
  when: predeploy_result is succeeded

- name: "Atualizar status para failed de {{ machine_name }}"
  ansible.builtin.copy:
    dest: "{{ status_file }}"
    content: |
      {
        "machine": "{{ machine_name }}",
        "host": "{{ machine_cfg.host }}",
        "package": "{{ machine_cfg.package }}",
        "rollback": "{{ machine_cfg.rollback | default('') }}",
        "status": "failed",
        "deployment_ref": "{{ deployment_ref }}",
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "stdout": {{ predeploy_result.stdout | to_json }},
        "stderr": {{ predeploy_result.stderr | to_json }}
      }
  when: predeploy_result is failed
