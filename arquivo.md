Exec using JSCH
Connecting to 10.218.238.144 ....
Connection to 10.218.238.144 established
Executing command ...
Clonando repo em /tmp/tmp.bQuoasAq4V/repo...
Cloning into '/tmp/tmp.bQuoasAq4V/repo'...
remote: Enumerating objects: 43, done.
remote: Counting objects:   2% (1/43)
remote: Counting objects:   4% (2/43)
remote: Counting objects:   6% (3/43)
remote: Counting objects:   9% (4/43)
remote: Counting objects:  11% (5/43)
remote: Counting objects:  13% (6/43)
remote: Counting objects:  16% (7/43)
remote: Counting objects:  18% (8/43)
remote: Counting objects:  20% (9/43)
remote: Counting objects:  23% (10/43)
remote: Counting objects:  25% (11/43)
remote: Counting objects:  27% (12/43)
remote: Counting objects:  30% (13/43)
remote: Counting objects:  32% (14/43)
remote: Counting objects:  34% (15/43)
remote: Counting objects:  37% (16/43)
remote: Counting objects:  39% (17/43)
remote: Counting objects:  41% (18/43)
remote: Counting objects:  44% (19/43)
remote: Counting objects:  46% (20/43)
remote: Counting objects:  48% (21/43)
remote: Counting objects:  51% (22/43)
remote: Counting objects:  53% (23/43)
remote: Counting objects:  55% (24/43)
remote: Counting objects:  58% (25/43)
remote: Counting objects:  60% (26/43)
remote: Counting objects:  62% (27/43)
remote: Counting objects:  65% (28/43)
remote: Counting objects:  67% (29/43)
remote: Counting objects:  69% (30/43)
remote: Counting objects:  72% (31/43)
remote: Counting objects:  74% (32/43)
remote: Counting objects:  76% (33/43)
remote: Counting objects:  79% (34/43)
remote: Counting objects:  81% (35/43)
remote: Counting objects:  83% (36/43)
remote: Counting objects:  86% (37/43)
remote: Counting objects:  88% (38/43)
remote: Counting objects:  90% (39/43)
remote: Counting objects:  93% (40/43)
remote: Counting objects:  95% (41/43)
remote: Counting objects:  97% (42/43)
remote: Counting objects: 100% (43/43)
remote: Counting objects: 100% (43/43), done.
remote: Compressing objects:   2% (1/36)
remote: Compressing objects:   5% (2/36)
remote: Compressing objects:   8% (3/36)
remote: Compressing objects:  11% (4/36)
remote: Compressing objects:  13% (5/36)
remote: Compressing objects:  16% (6/36)
remote: Compressing objects:  19% (7/36)
remote: Compressing objects:  22% (8/36)
remote: Compressing objects:  25% (9/36)
remote: Compressing objects:  27% (10/36)
remote: Compressing objects:  30% (11/36)
remote: Compressing objects:  33% (12/36)
remote: Compressing objects:  36% (13/36)
remote: Compressing objects:  38% (14/36)
remote: Compressing objects:  41% (15/36)
remote: Compressing objects:  44% (16/36)
remote: Compressing objects:  47% (17/36)
remote: Compressing objects:  50% (18/36)
remote: Compressing objects:  52% (19/36)
remote: Compressing objects:  55% (20/36)
remote: Compressing objects:  58% (21/36)
remote: Compressing objects:  61% (22/36)
remote: Compressing objects:  63% (23/36)
remote: Compressing objects:  66% (24/36)
remote: Compressing objects:  69% (25/36)
remote: Compressing objects:  72% (26/36)
remote: Compressing objects:  75% (27/36)
remote: Compressing objects:  77% (28/36)
remote: Compressing objects:  80% (29/36)
remote: Compressing objects:  83% (30/36)
remote: Compressing objects:  86% (31/36)
remote: Compressing objects:  88% (32/36)
remote: Compressing objects:  91% (33/36)
remote: Compressing objects:  94% (34/36)
remote: Compressing objects:  97% (35/36)
remote: Compressing objects: 100% (36/36)
remote: Compressing objects: 100% (36/36), done.
remote: Total 43 (delta 16), reused 0 (delta 0), pack-reused 0
Receiving objects:   2% (1/43)
Receiving objects:   4% (2/43)
Receiving objects:   6% (3/43)
Receiving objects:   9% (4/43)
Receiving objects:  11% (5/43)
Receiving objects:  13% (6/43)
Receiving objects:  16% (7/43)
Receiving objects:  18% (8/43)
Receiving objects:  20% (9/43)
Receiving objects:  23% (10/43)
Receiving objects:  25% (11/43)
Receiving objects:  27% (12/43)
Receiving objects:  30% (13/43)
Receiving objects:  32% (14/43)
Receiving objects:  34% (15/43)
Receiving objects:  37% (16/43)
Receiving objects:  39% (17/43)
Receiving objects:  41% (18/43)
Receiving objects:  44% (19/43)
Receiving objects:  46% (20/43)
Receiving objects:  48% (21/43)
Receiving objects:  51% (22/43)
Receiving objects:  53% (23/43)
Receiving objects:  55% (24/43)
Receiving objects:  58% (25/43)
Receiving objects:  60% (26/43)
Receiving objects:  62% (27/43)
Receiving objects:  65% (28/43)
Receiving objects:  67% (29/43)
Receiving objects:  69% (30/43)
Receiving objects:  72% (31/43)
Receiving objects:  74% (32/43)
Receiving objects:  76% (33/43)
Receiving objects:  79% (34/43)
Receiving objects:  81% (35/43)
Receiving objects:  83% (36/43)
Receiving objects:  86% (37/43)
Receiving objects:  88% (38/43)
Receiving objects:  90% (39/43)
Receiving objects:  93% (40/43)
Receiving objects:  95% (41/43)
Receiving objects:  97% (42/43)
Receiving objects: 100% (43/43)
Receiving objects: 100% (43/43), 8.04 KiB | 8.04 MiB/s, done.
Resolving deltas:   0% (0/16)
Resolving deltas:   6% (1/16)
Resolving deltas:  12% (2/16)
Resolving deltas:  18% (3/16)
Resolving deltas:  25% (4/16)
Resolving deltas:  31% (5/16)
Resolving deltas:  37% (6/16)
Resolving deltas:  43% (7/16)
Resolving deltas:  50% (8/16)
Resolving deltas:  56% (9/16)
Resolving deltas:  62% (10/16)
Resolving deltas:  68% (11/16)
Resolving deltas:  75% (12/16)
Resolving deltas:  81% (13/16)
Resolving deltas:  87% (14/16)
Resolving deltas:  93% (15/16)
Resolving deltas: 100% (16/16)
Resolving deltas: 100% (16/16), done.
ConteÃºdo do repo:
total 8
drwxr-x---. 7 ec2-user ec2-user   98 Jan  8 18:09 .
drwx------. 3 ec2-user ec2-user   18 Jan  8 18:09 ..
drwxr-x---. 3 ec2-user ec2-user   42 Jan  8 18:09 ansible
drwxr-x---. 2 ec2-user ec2-user   27 Jan  8 18:09 execution
drwxr-x---. 8 ec2-user ec2-user  163 Jan  8 18:09 .git
drwxr-x---. 2 ec2-user ec2-user   26 Jan  8 18:09 machines
-rw-r-----. 1 ec2-user ec2-user 6376 Jan  8 18:09 README.md
drwxr-x---. 2 ec2-user ec2-user   21 Jan  8 18:09 scripts
PWD do repo:
/tmp/tmp.bQuoasAq4V/repo
ERROR! We were unable to read either as JSON nor YAML, these are the errors we got from each:
JSON: Expecting value: line 1 column 1 (char 0)
Syntax Error while loading YAML.
  mapping values are not allowed in this context
The error appears to be in '/tmp/tmp.bQuoasAq4V/repo/ansible/playbooks/deploy_from_execution.yml': line 164, column 11, but may
be elsewhere in the file depending on the exact syntax problem.
The offending line appears to be:
    - name: Download artifacts from S3 to target folder
          ^ here
Command finished with status FAILURE



---
- name: Build dynamic target list from execution + machines folder
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    execution_file_default: "../../execution/execution.yml"
    machines_dir_default: "../../machines"

  tasks:
    - name: Resolve paths
      set_fact:
        execution_file_path: "{{ execution_file | default(execution_file_default) }}"
        machines_dir_path: "{{ machines_dir | default(machines_dir_default) }}"

    - name: Load execution file
      include_vars:
        file: "{{ execution_file_path }}"
        name: exec

    - name: Validate execution targets
      assert:
        that:
          - exec.targets is defined
          - exec.targets | length > 0
        fail_msg: "No targets found in {{ execution_file_path }} (targets is empty)."

    - name: Check machine files exist
      stat:
        path: "{{ machines_dir_path }}/{{ item }}.yml"
      register: machine_files
      loop: "{{ exec.targets }}"

    - name: Fail if any machine file is missing
      assert:
        that: item.stat.exists
        fail_msg: "Missing machine definition: {{ machines_dir_path }}/{{ item.item }}.yml"
      loop: "{{ machine_files.results }}"

    - name: Load machine definitions
      include_vars:
        file: "{{ machines_dir_path }}/{{ item }}.yml"
        name: "m_{{ item | replace('-', '_') }}"
      loop: "{{ exec.targets }}"

    - name: Add targets dynamically (per machine vars)
      add_host:
        name: "{{ item }}"
        groups: deliver_targets

        ansible_host: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).ssh.host }}"
        ansible_user: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).ssh.user | default('ec2-user') }}"

        # If you need a specific key on bastion, uncomment:
        # ansible_ssh_private_key_file: "/home/ec2-user/.ssh/sitef_key"

        s3_region: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).s3.region }}"
        s3_bucket: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).s3.bucket }}"
        s3_prefix: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).s3.prefix }}"

        download_dir: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).deploy.download_dir | default('/opt/sitef/downloads') }}"
        scripts_dir: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).deploy.scripts_dir | default('/opt/sitef/scripts') }}"
        init_script: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).deploy.init_script | default('init.sh') }}"
        init_args: "{{ lookup('vars', 'm_' ~ (item | replace('-', '_'))).deploy.init_args | default('') }}"
      loop: "{{ exec.targets }}"

    - name: Show selected targets
      debug:
        msg:
          - "Execution file: {{ execution_file_path }}"
          - "Machines dir: {{ machines_dir_path }}"
          - "Selected targets: {{ exec.targets }}"

- name: Deliver to selected machines (download from S3 + run script)
  hosts: deliver_targets
  gather_facts: true
  become: true

  vars:
    aws_cli_cmd: aws

  tasks:
    - name: Ensure directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ scripts_dir }}"
        - "{{ download_dir }}"

    - name: Copy scripts to target
      copy:
        src: "../../scripts/"
        dest: "{{ scripts_dir }}/"
        mode: "0755"

    - name: Check AWS CLI exists on target
      command: "{{ aws_cli_cmd }} --version"
      register: awscli_check
      changed_when: false
      

    - name: Download artifacts from S3 to target folder
      command: >
        {{ aws_cli_cmd }} s3 sync
        s3://{{ s3_bucket }}/{{ s3_prefix }}
        {{ download_dir }}/
        --region {{ s3_region }}
      register: s3sync
      changed_when: >
        ('download:' in s3sync.stdout) or
        ('copy:' in s3sync.stdout) or
        ('update:' in s3sync.stdout)

    - name: Execute init script
      command: "{{ scripts_dir }}/{{ init_script }} {{ init_args }}"
      args:
        chdir: "{{ scripts_dir }}"
      register: init_out

    - name: Show init output
      debug:
        var: init_out.stdout_lines
